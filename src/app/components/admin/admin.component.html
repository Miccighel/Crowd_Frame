<!-- Local admin overlay host -->
<ngx-ui-loader
  [loaderId]="'admin'"
  [bgsColor]="'#3f51b5'"
  [fgsColor]="'#3f51b5'"
  [pbColor]="'#3f51b5'"
  [fgsSize]="120"
  [bgsPosition]="'bottom-right'"
  [bgsSize]="80"
  [bgsType]="'ball-spin-clockwise'"
  [text]="'Working…'"
  [textColor]="'#FFFFFF'"
  [textPosition]="'bottom-center'">
</ngx-ui-loader>

<!-- Login gate -->
@if (!loginGranted) {
  <div class="admin-login mat-app-background">
    <mat-card class="login-card mat-elevation-z4" appearance="outlined">
      <mat-card-header>
        <div class="login-title">
          <mat-icon class="brand-icon">admin_panel_settings</mat-icon>
          <h1 class="brand">Admin</h1>
        </div>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="loginForm" novalidate>
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Insert your username</mat-label>
            <input matInput type="text" placeholder="your_username" formControlName="username" autocomplete="username"/>
            @if (loginForm.get('username')?.hasError('required')) {
              <mat-error>This field is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Insert your password</mat-label>
            <input matInput type="password" placeholder="your_password" formControlName="password" autocomplete="current-password"/>
            @if (loginForm.get('password')?.hasError('required')) {
              <mat-error>This field is required</mat-error>
            }
          </mat-form-field>

          @if (loginAttempted && !loginGranted) {
            <mat-error class="mt-8">Invalid credentials</mat-error>
          }
        </form>
      </mat-card-content>

      <mat-card-actions align="end">
        <button mat-flat-button color="primary" type="button" (click)="verifyAdminCredentials()">
          <mat-icon>login</mat-icon>
          <span>Login</span>
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
}

<!-- Admin workspace -->
@if (loginGranted) {
  <mat-sidenav-container class="admin-shell mat-app-background">
    <!-- Left rail -->
    <mat-sidenav #drawer class="admin-nav" mode="side" [opened]="true">
      <div class="nav-header">
        <mat-icon class="brand-icon">dashboard</mat-icon>
        <div class="brand-block">
          <div class="brand">Admin</div>
          <div class="subtitle">Crowd_Frame</div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Sidebar tabs: ACL (default), DATA, Storage, Health, Generator -->
      <mat-nav-list>
        <a mat-list-item (click)="setActivePanel('acl')" [class.active]="activePanel === 'acl'">
          <mat-icon matListItemIcon>lock</mat-icon>
          <div matListItemTitle>ACL</div>
          <div matListItemLine>Access control records</div>
        </a>

        <a mat-list-item (click)="setActivePanel('data')" [class.active]="activePanel === 'data'">
          <mat-icon matListItemIcon>table_chart</mat-icon>
          <div matListItemTitle>Data</div>
          <div matListItemLine>Worker data records</div>
        </a>

        <a mat-list-item (click)="setActivePanel('storage')" [class.active]="activePanel === 'storage'">
          <mat-icon matListItemIcon>cloud_lock</mat-icon>
          <div matListItemTitle>Private bucket</div>
          <div matListItemLine>Browse &amp; delete</div>
        </a>

        <a mat-list-item (click)="setActivePanel('health')" [class.active]="activePanel === 'health'">
          <mat-icon matListItemIcon>rule_settings</mat-icon>
          <div matListItemTitle>Deployment health</div>
          <div matListItemLine>ACL ↔ HIT tokens</div>
        </a>

        <a mat-list-item (click)="setActivePanel('generator')" [class.active]="activePanel === 'generator'">
          <mat-icon matListItemIcon>build_circle</mat-icon>
          <div matListItemTitle>Generator</div>
          <div matListItemLine>Configure &amp; publish</div>
        </a>
      </mat-nav-list>
    </mat-sidenav>

    <!-- Main content area -->
    <mat-sidenav-content class="admin-content">
      <mat-toolbar color="primary" class="admin-toolbar">
        <button mat-icon-button class="show-when-narrow" (click)="drawer.toggle()" aria-label="Toggle menu">
          <mat-icon>menu</mat-icon>
        </button>

        <div class="toolbar-title">
          <mat-icon>admin_panel_settings</mat-icon>
          <span>Admin Console</span>
        </div>

        <span class="flex-spacer"></span>
      </mat-toolbar>

      <div class="admin-main">
        <!-- ───────── ACL (simple + details) ───────── -->
        @if (activePanel === 'acl') {
          <div class="tab-pad">
            <div class="surface">
              <!-- Actions -->
              <div class="actions-row gap-12 mb-12">
                <button mat-stroked-button (click)="reloadAcl()" [disabled]="aclTable.loading">
                  <mat-icon>refresh</mat-icon><span>Refresh</span>
                </button>

                <span class="flex-spacer"></span>

                <mat-form-field appearance="outline" class="w-220">
                  <mat-label>Filter (client-side)</mat-label>
                  <input matInput [ngModel]="aclTable.filter" (ngModelChange)="onAclFilterChanged($event)" placeholder="Type to filter JSON…">
                </mat-form-field>
                <span class="muted count-label">Showing {{ aclTable.view.length }} item(s)</span>
              </div>

              <!-- Table -->
              <div class="table-scroll">
                <table class="table grid">
                  <thead>
                    <tr>
                      <th class="left pad">unit_id</th>
                      <th class="left pad">identifier</th>
                      <th class="left pad">ip_address</th>
                      <th class="left pad">in_progress</th>
                      <th class="left pad">paid</th>
                      <th class="left pad">time_arrival</th>
                      <th class="left pad">time_removal</th>
                      <th class="right pad">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of aclTable.view; track row.id) {
                      <tr>
                        <td class="left pad mono">{{ row.raw['unit_id'] ?? '—' }}</td>
                        <td class="left pad mono">{{ row.raw['identifier'] ?? '—' }}</td>
                        <td class="left pad mono">{{ row.raw['ip_address'] ?? '—' }}</td>
                        <td class="left pad">
                          <span class="pill" [class.true]="(row.raw['in_progress']||'').toString().toLowerCase()==='true'"
                                            [class.false]="(row.raw['in_progress']||'').toString().toLowerCase()==='false'">
                            {{ row.raw['in_progress'] ?? '—' }}
                          </span>
                        </td>
                        <td class="left pad">
                          <span class="pill" [class.true]="(row.raw['paid']||'').toString().toLowerCase()==='true'"
                                            [class.false]="(row.raw['paid']||'').toString().toLowerCase()==='false'">
                            {{ row.raw['paid'] ?? '—' }}
                          </span>
                        </td>
                        <td class="left pad">{{ row.raw['time_arrival'] ?? '—' }}</td>
                        <td class="left pad">{{ row.raw['time_removal'] ?? '—' }}</td>
                        <td class="right pad">
                          <button mat-icon-button matTooltip="Details" (click)="toggleAclExpand(row.id)">
                            <mat-icon>{{ isAclExpanded(row.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
                          </button>
                          <button mat-icon-button matTooltip="Copy JSON" (click)="copyRowJson(row)">
                            <mat-icon>content_copy</mat-icon>
                          </button>
                        </td>
                      </tr>
                      @if (isAclExpanded(row.id)) {
                        <tr class="expand-row">
                          <!-- colspan matches header columns (8) -->
                          <td class="pad" colspan="8">
                            <div class="kv-grid">
                              @for (e of entriesOf(row.raw); track e.key) {
                                <div class="kv-key mono">{{ e.key }}</div>
                                <div class="kv-val mono">{{ e.value }}</div>
                              }
                            </div>
                          </td>
                        </tr>
                      }
                    }
                  </tbody>
                </table>
              </div>

              <!-- Pager -->
              <div class="pager-row">
                <button mat-stroked-button (click)="loadMoreAcl()" [disabled]="aclTable.loading || !aclTable.lastEvaluatedKey">
                  <span>Load more</span><mat-icon>expand_more</mat-icon>
                </button>
                <span class="flex-spacer"></span>
                <span class="muted">LastKey: {{ aclTable.lastEvaluatedKey ? 'yes' : 'no' }}</span>
              </div>
            </div>
          </div>
        }

        <!-- ───────── DATA (simple + details) ───────── -->
        @if (activePanel === 'data') {
          <div class="tab-pad">
            <div class="surface">
              <!-- Actions -->
              <div class="actions-row gap-12 mb-12">
                <mat-form-field appearance="outline" class="w-220">
                  <mat-label>Identifier</mat-label>
                  <input matInput [formControl]="dataTable.identifierCtrl" placeholder="worker_123 …">
                </mat-form-field>

                <button mat-stroked-button
                        (click)="reloadData()
"
                        [disabled]="dataTable.loading || !dataTable.identifierCtrl.value">
                  <mat-icon>file_download</mat-icon><span>Load</span>
                </button>

                <span class="flex-spacer"></span>

                <mat-form-field appearance="outline" class="w-220">
                  <mat-label>Filter (client-side)</mat-label>
                  <input matInput [ngModel]="dataTable.filter" (ngModelChange)="onDataFilterChanged($event)" placeholder="Type to filter JSON…">
                </mat-form-field>
                <span class="muted count-label">Showing {{ dataTable.view.length }} item(s)</span>
              </div>

              <!-- Table -->
              <div class="table-scroll">
                <table class="table grid">
                  <thead>
                    <tr>
                      <th class="left pad">identifier</th>
                      <th class="left pad">sequence</th>
                      <th class="left pad">time</th>
                      <th class="right pad">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of dataTable.view; track row.id) {
                      <tr>
                        <td class="left pad mono">{{ row.raw['identifier'] ?? '—' }}</td>
                        <td class="left pad mono">{{ row.raw['sequence'] ?? '—' }}</td>
                        <td class="left pad">{{ row.raw['time'] ?? '—' }}</td>
                        <td class="right pad">
                          <button mat-icon-button matTooltip="Details" (click)="toggleDataExpand(row.id)">
                            <mat-icon>{{ isDataExpanded(row.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
                          </button>
                          <button mat-icon-button matTooltip="Copy JSON" (click)="copyRowJson(row)">
                            <mat-icon>content_copy</mat-icon>
                          </button>
                        </td>
                      </tr>
                      @if (isDataExpanded(row.id)) {
                        <tr class="expand-row">
                          <!-- DATA has 4 visible columns -->
                          <td class="pad" colspan="4">
                            <div class="kv-grid">
                              @for (e of entriesOf(row.raw); track e.key) {
                                <div class="kv-key mono">{{ e.key }}</div>
                                <div class="kv-val mono">{{ e.value }}</div>
                              }
                            </div>
                          </td>
                        </tr>
                      }
                    }
                  </tbody>
                </table>
              </div>

              <!-- Pager -->
              <div class="pager-row">
                <button mat-stroked-button (click)="loadMoreData()" [disabled]="dataTable.loading || !dataTable.lastEvaluatedKey">
                  <span>Load more</span><mat-icon>expand_more</mat-icon>
                </button>
                <span class="flex-spacer"></span>
                <span class="muted">LastKey: {{ dataTable.lastEvaluatedKey ? 'yes' : 'no' }}</span>
              </div>
            </div>
          </div>
        }

        <!-- ───────── Private bucket (scoped) ───────── -->
        @if (activePanel === 'storage') {
          <div class="tab-pad">
            <div class="surface">
              <!-- Actions -->
              <div class="actions-row gap-12 mb-12">
                <!-- Read-only scope preview -->
                <div class="prefix-pill surface" style="padding:6px 10px; display:inline-flex; align-items:center; gap:6px;">
                  <mat-icon>folder</mat-icon>
                  <span>Scope:</span>
                  <code class="mono">{{ storageState.prefix || '—' }}</code>
                </div>

                <button mat-stroked-button (click)="reloadStorage()" [disabled]="storageState.isLoading">
                  <mat-icon>refresh</mat-icon><span>Refresh</span>
                </button>

                <span class="flex-spacer"></span>

                <mat-form-field appearance="outline" class="w-220">
                  <mat-label>Filter</mat-label>
                  <input matInput [ngModel]="storageState.filter" (ngModelChange)="onStorageFilterChanged($event)" placeholder="Type to filter…">
                </mat-form-field>

                <button mat-flat-button color="warn"
                        (click)="deleteSelectedStorage()"
                        [disabled]="!storageHasSelection() || storageState.isLoading">
                  <mat-icon>delete</mat-icon>
                  <span>Delete selected</span>
                </button>
              </div>

              <!-- Table -->
              <div class="table-scroll">
                <table class="table grid">
                  <thead>
                    <tr>
                      <th class="left pad">
                        <mat-checkbox [checked]="storageAllSelected()" (change)="storageToggleAll($event.checked)"></mat-checkbox>
                      </th>
                      <th class="left pad" (click)="toggleStorageSort('key')">
                        <div class="th-inner">Key <mat-icon class="sort-icon">unfold_more</mat-icon></div>
                      </th>
                      <th class="right pad" (click)="toggleStorageSort('size')">
                        <div class="th-inner">Size</div>
                      </th>
                      <th class="left pad">Last modified</th>
                      <th class="left pad">Class</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of storageState.view; track row.id) {
                      <tr>
                        <td class="pad"><mat-checkbox [(ngModel)]="row.selected" aria-label="Select object"></mat-checkbox></td>
                        <td class="left pad mono"><span class="ellipsis col-data">{{ row.key }}</span></td>
                        <td class="right pad">{{ row.size | number }} B</td>
                        <td class="left pad">{{ row.lastModified || '—' }}</td>
                        <td class="left pad">{{ row.storageClass || '—' }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>

              <!-- Pager -->
              <div class="pager-row">
                <button mat-stroked-button (click)="loadMoreStorage()" [disabled]="storageState.isLoading || !storageState.nextToken">
                  <span>Load more</span>
                  <mat-icon>expand_more</mat-icon>
                </button>
                <span class="flex-spacer"></span>
                <span class="muted">Showing {{ storageState.view.length }} item(s)</span>
              </div>
            </div>
          </div>
        }

        <!-- ───────── Deployment health ───────── -->
        @if (activePanel === 'health') {
          <div class="tab-pad">
            <div class="surface">
              <!-- Actions -->
              <div class="actions-row">
                <button mat-stroked-button (click)="scanDeploymentHealth()" [disabled]="isScanning">
                  <mat-icon>refresh</mat-icon>
                  <span>Scan now</span>
                </button>

                <span class="flex-spacer"></span>

                <button mat-flat-button color="accent"
                        (click)="applySelectedFixes()"
                        [disabled]="deploymentMismatches.length === 0">
                  <mat-icon>done_all</mat-icon>
                  <span>Apply selected</span>
                </button>
              </div>

              <div class="legend">
                <mat-chip-set>
                  <mat-chip selected color="primary">Adopt</mat-chip>
                  <mat-chip selected color="warn">Release</mat-chip>
                </mat-chip-set>
                <span class="hint" *ngIf="deploymentMismatches.length === 0">No mismatches detected yet.</span>
              </div>

              @if (deploymentMismatches.length > 0) {
                <div class="table-wrap">
                  <table class="table">
                    <thead>
                      <tr>
                        <th class="left pad">Select</th>
                        <th class="left">Unit</th>
                        <th class="left pad">ACL token_in</th>
                        <th class="left">ACL token_out</th>
                        <th class="left pad">New token_in</th>
                        <th class="left">New token_out</th>
                        <th class="right pad">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (row of deploymentMismatches; track row.unitId) {
                        <tr>
                          <td class="pad">
                            <mat-checkbox [(ngModel)]="row.selected" aria-label="Select row"></mat-checkbox>
                          </td>
                          <td class="mono">{{ row.unitId }}</td>
                          <td class="mono pad">{{ row.aclTokenInput }}</td>
                          <td class="mono">{{ row.aclTokenOutput }}</td>
                          <td class="mono pad">{{ row.newTokenInput || '—' }}</td>
                          <td class="mono">{{ row.newTokenOutput || '—' }}</td>
                          <td class="right pad">
                            <mat-chip-set>
                              @if (row.recommend === 'adopt') { <mat-chip color="primary" selected>Adopt</mat-chip> }
                              @if (row.recommend === 'release') { <mat-chip color="warn" selected>Release</mat-chip> }
                              @if (row.recommend === 'none') { <mat-chip>None</mat-chip> }
                            </mat-chip-set>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
          </div>
        }

        <!-- ───────── Generator (lazy mount) ───────── -->
        @if (activePanel === 'generator' && mount.generator) {
          <div class="tab-pad">
            <div [@.disabled]="true">
              <app-generator></app-generator>
            </div>
          </div>
        }
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>
}
