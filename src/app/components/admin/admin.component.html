<!-- Local admin overlay host -->
<ngx-ui-loader
    [loaderId]="'admin'"
    [bgsColor]="'#3f51b5'"
    [fgsColor]="'#3f51b5'"
    [pbColor]="'#3f51b5'"
    [fgsSize]="120"
    [bgsPosition]="'bottom-right'"
    [bgsSize]="80"
    [bgsType]="'ball-spin-clockwise'"
    [text]="'Working…'"
    [textColor]="'#FFFFFF'"
    [textPosition]="'bottom-center'">
</ngx-ui-loader>

<!-- Login gate -->
@if (!loginGranted) {
    <div class="admin-login mat-app-background">
        <mat-card class="login-card mat-elevation-z4" appearance="outlined">
            <mat-card-header>
                <div class="login-title">
                    <mat-icon class="brand-icon">admin_panel_settings</mat-icon>
                    <h1 class="brand">Admin</h1>
                </div>
            </mat-card-header>

            <mat-card-content>
                <form [formGroup]="loginForm" novalidate>
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Insert your username</mat-label>
                        <input matInput type="text" placeholder="your_username" formControlName="username" autocomplete="username"/>
                        @if (checkFormControl(loginForm, 'username', 'required')) {
                            <mat-error>This field is required</mat-error>
                        }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Insert your password</mat-label>
                        <input matInput type="password" placeholder="your_password" formControlName="password" autocomplete="current-password"/>
                        @if (checkFormControl(loginForm, 'password', 'required')) {
                            <mat-error>This field is required</mat-error>
                        }
                    </mat-form-field>

                    @if (loginAttempted && !loginGranted) {
                        <mat-error class="mt-8">Invalid credentials</mat-error>
                    }
                </form>
            </mat-card-content>

            <mat-card-actions align="end">
                <button mat-flat-button color="primary" type="button" (click)="verifyAdminCredentials()">
                    <mat-icon>login</mat-icon>
                    <span>Login</span>
                </button>
            </mat-card-actions>
        </mat-card>
    </div>
}

<!-- Admin workspace -->
@if (loginGranted) {
    <mat-sidenav-container class="admin-shell mat-app-background">
        <!-- Left rail -->
        <mat-sidenav #drawer class="admin-nav" mode="side" [opened]="true">
            <div class="nav-header">
                <mat-icon class="brand-icon">dashboard</mat-icon>
                <div class="brand-block">
                    <div class="brand">Admin</div>
                    <div class="subtitle">Crowd_Frame</div>
                </div>
            </div>

            <mat-divider></mat-divider>

            <mat-nav-list>
                <a mat-list-item (click)="activePanel = 'generator'" [class.active]="activePanel === 'generator'">
                    <mat-icon matListItemIcon>build_circle</mat-icon>
                    <div matListItemTitle>Generator</div>
                    <div matListItemLine>Configure &amp; publish</div>
                </a>

                <a mat-list-item (click)="activePanel = 'health'" [class.active]="activePanel === 'health'">
                    <mat-icon matListItemIcon>rule_settings</mat-icon>
                    <div matListItemTitle>Deployment health</div>
                    <div matListItemLine>ACL ↔ HIT tokens</div>
                </a>
            </mat-nav-list>


        </mat-sidenav>

        <!-- Main area -->
        <mat-sidenav-content class="admin-content">
            <mat-toolbar color="primary" class="admin-toolbar">
                <button mat-icon-button class="show-when-narrow" (click)="drawer.toggle()" aria-label="Toggle menu">
                    <mat-icon>menu</mat-icon>
                </button>

                <div class="toolbar-title">
                    <mat-icon>admin_panel_settings</mat-icon>
                    <span>Admin Console</span>
                </div>

                <span class="flex-spacer"></span>
                <!-- No per-view toolbar buttons anymore -->
            </mat-toolbar>

            <!-- Generator view -->
            @if (activePanel === 'generator') {
                <div class="tab-pad">
                    <app-generator></app-generator>
                </div>
            }

            <!-- Deployment health view -->
            @if (activePanel === 'health') {
                <div class="tab-pad">
                    <!-- View actions row -->
                    <div class="actions-row">
                        <button mat-stroked-button (click)="scanDeploymentHealth()" [disabled]="isScanning">
                            <mat-icon>refresh</mat-icon>
                            <span>Scan now</span>
                        </button>

                        <span class="flex-spacer"></span>

                        <button mat-flat-button color="accent"
                                (click)="applySelectedFixes()"
                                [disabled]="deploymentMismatches.length === 0">
                            <mat-icon>done_all</mat-icon>
                            <span>Apply selected</span>
                        </button>
                    </div>

                    <!-- Legend / Empty state -->
                    <div class="legend">
                        <mat-chip-set>
                            <mat-chip selected color="primary">Adopt</mat-chip>
                            <mat-chip selected color="warn">Release</mat-chip>
                        </mat-chip-set>
                        <span class="hint" *ngIf="deploymentMismatches.length === 0">No mismatches detected yet.</span>
                    </div>

                    <!-- Results table -->
                    @if (deploymentMismatches.length > 0) {
                        <div class="table-wrap">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th class="left pad">Select</th>
                                    <th class="left">Unit</th>
                                    <th class="left pad">ACL token_in</th>
                                    <th class="left">ACL token_out</th>
                                    <th class="left pad">New token_in</th>
                                    <th class="left">New token_out</th>
                                    <th class="right pad">Action</th>
                                </tr>
                                </thead>
                                <tbody>
                                    @for (row of deploymentMismatches; track row.unitId) {
                                        <tr>
                                            <td class="pad">
                                                <mat-checkbox [(ngModel)]="row.selected" aria-label="Select row"></mat-checkbox>
                                            </td>
                                            <td class="mono">{{ row.unitId }}</td>
                                            <td class="mono pad">{{ row.aclTokenInput }}</td>
                                            <td class="mono">{{ row.aclTokenOutput }}</td>
                                            <td class="mono pad">{{ row.newTokenInput || '—' }}</td>
                                            <td class="mono">{{ row.newTokenOutput || '—' }}</td>
                                            <td class="right pad">
                                                <mat-chip-set>
                                                    @if (row.recommend === 'adopt') {
                                                        <mat-chip color="primary" selected>Adopt</mat-chip>
                                                    }
                                                    @if (row.recommend === 'release') {
                                                        <mat-chip color="warn" selected>Release</mat-chip>
                                                    }
                                                    @if (row.recommend === 'none') {
                                                        <mat-chip>None</mat-chip>
                                                    }
                                                </mat-chip-set>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            }
        </mat-sidenav-content>
    </mat-sidenav-container>
}
