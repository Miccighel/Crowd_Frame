<!-- ────────────────────────────────────────────────────────────
Re-usable template that prints a list of dimensions
(works for both initial and post-assessment forms)
──────────────────────────────────────────────────────────── -->
<ng-template #dimensionTemplate
  let-dimensions="dimensions"
  let-position="position"
  let-assessmentForm="assessmentForm"
  let-controlSuffix="controlSuffix">
  <form [formGroup]="assessmentForm">

    @for (dimension of dimensions; track dimension; let i = $index) {
      <div class="dimension">
        <!-- ───────────────────────────── NON-PAIRWISE ───────────────────────────── -->
        @if (!dimension.pairwise) {
          <!-- ───────────── LIST STYLE ───────────── -->
          @if (dimension.style.type == 'list') {
            <div class="dimension">
              <!-- Search-engine widget (optional) -->
              <app-search-engine
                [documentIndex]="documentIndex"
                [dimensionIndex]="dimension.index"
                [worker]="worker"
                [searchEngineForms]="searchEngineForms"
                [resultsRetrievedForms]="resultsRetrievedForms"
                (formEmitter)="storeSearchEngineUrl($event, dimension.index)">
              </app-search-engine>
              @if (verifyUrlSelection(position) && checkIfDimensionIsEnabledForPostAssessment(dimension.name)) {
                <!-- Optional instructions -->
                @if (dimension.scale?.instructions; as ins) {
                  <div class="evaluation-instructions">
                    <!-- first time -->
                    @if (!postAssessment) {
                      <h2>
                        @if (ins.label) {
                          <span>{{ ins.label }} – </span>
                          }{{ ins.caption }}
                        </h2>
                      }
                      <!-- repetition -->
                      @if (postAssessment && ins.labelRepetition && ins.captionRepetition) {
                        <h2>
                          @if (ins.labelRepetition) {
                            <span>{{ ins.labelRepetition }} – </span>
                            }{{ ins.captionRepetition }}
                          </h2>
                        }
                      </div>
                    }
                    <!-- Pretty name & description -->
                    @if (dimension.name_pretty) {
                      <div class="dimension-name">
                        <h2>{{ utilsService.capitalize(dimension.name_pretty) }}</h2>
                      </div>
                    }
                    @if (dimension.description) {
                      <div class="dimension-container dimension-description">
                        <div class="dimension-content">
                          <p>{{ dimension.description }}</p>
                          @if (dimension.example) {
                            <i class="dimension-example">{{ dimension.example }}</i>
                          }
                        </div>
                      </div>
                    }
                    <!-- ───────────── SCALE CONTROLS ───────────── -->
                    @if (dimension.scale) {
                      <div class="dimension-container dimension-scale">
                        <div class="dimension-content">
                          <!-- ───── Vertical layout ───── -->
                          @if (dimension.style.orientation == 'vertical') {
                            <!-- ─── Categorical ─── -->
                            @if (dimension.scale.type == 'categorical') {
                              <!-- video special-case -->
                              @if (isVideoTypeLabelCategorical(dimension)) {
                                <mat-radio-group class="radio-button-group"
                                  formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                  @if (!dimension.scale.multipleSelection) {
                                    @for (mapping of dimension.scale.mapping; track mapping) {
                                      @if (mapping.separator) {
                                        <mat-divider inset></mat-divider>
                                      }
                                      <mat-radio-button
                                        value="{{ mapping.value }}"
                                        [disabled]="categoricalDimensionDisabled(dimension)"
                                        [attr.disabled]="task.countdownsExpired[documentIndex] && task.settings.countdown_behavior == 'disable_forms'"
                                        [ngClass]="mapping.separator ? 'radio-button radio-button-separated' : 'radio-button'"
                                        (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)">
                                        <span class="mapping-label">{{ mapping.label }}</span>
                                        @if (mapping.description) {
                                          <span>{{ ' (' + mapping.description + ')' }}</span>
                                        }
                                      </mat-radio-button>
                                    }
                                  }
                                  <!-- multi-choice -->
                                  @if (dimension.scale.multipleSelection) {
                                    <div class="checkbox">
                                      <div formGroupName="{{ dimension.name + '_list' + controlSuffix }}">
                                        @for (mapping of dimension.scale.mapping; track mapping; let k = $index) {
                                          <div>
                                            <mat-checkbox formControlName="{{ k }}"
                                              (change)="handleCheckbox($event, dimension, k)">
                                              {{ mapping.label }}
                                            </mat-checkbox>
                                          </div>
                                        }
                                      </div>
                                      <mat-form-field>
                                        <input matInput formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                      </mat-form-field>
                                    </div>
                                  }
                                </mat-radio-group>
                              } @else {
                                <mat-radio-group class="radio-button-group"
                                  formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                  @if (!dimension.scale.multipleSelection) {
                                    @for (mapping of dimension.scale.mapping; track mapping) {
                                      @if (mapping.separator) {
                                        <mat-divider inset></mat-divider>
                                      }
                                      <mat-radio-button
                                        value="{{ mapping.value }}"
                                        [attr.disabled]="task.countdownsExpired[documentIndex] && task.settings.countdown_behavior == 'disable_forms'"
                                        [ngClass]="mapping.separator ? 'radio-button radio-button-separated' : 'radio-button'"
                                        (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false); detectCategoricalDimensionOnChange($event)">
                                        <span class="mapping-label">{{ mapping.label }}</span>
                                        @if (mapping.description) {
                                          <span>{{ ' (' + mapping.description + ')' }}</span>
                                        }
                                      </mat-radio-button>
                                    }
                                  }
                                  <!-- multi-choice -->
                                  @if (dimension.scale.multipleSelection) {
                                    <div class="checkbox">
                                      <div formGroupName="{{ dimension.name + '_list' + controlSuffix }}">
                                        @for (mapping of dimension.scale.mapping; track mapping; let k = $index) {
                                          <div>
                                            <mat-checkbox formControlName="{{ k }}"
                                              (change)="handleCheckbox($event, dimension, k)">
                                              {{ mapping.label }}
                                            </mat-checkbox>
                                          </div>
                                        }
                                      </div>
                                      <mat-form-field>
                                        <input matInput formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                      </mat-form-field>
                                    </div>
                                  }
                                </mat-radio-group>
                              }
                              <!-- regular categorical -->
                            }
                            <!-- ─── Interval ─── -->
                            @if (dimension.scale.type == 'interval') {
                              <!-- video timestamp slider -->
                              @if (isVideoTimestampInterval()) {
                                <div class="scale-interval">
                                  <mat-slider [disabled]="sliderDisabled()"
                                    [min]="task.dimensionIntervalMinValues[documentIndex]"
                                    [max]="task.dimensionIntervalMaxValues[documentIndex]"
                                    [step]="dimension.scale.step">
                                    <input matSliderThumb
                                      formControlName="{{ dimension.name + '_value' + controlSuffix }}"
                                      (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)"
														   [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                  task.settings.countdown_behavior == 'disable_forms'">
                                    </mat-slider>
                                    @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value === '') {
                                      <span>
                                        Value: 00:00.00
                                      </span>
                                    }
                                    @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value !== '') {
                                      <span>
                                        Value:
                                        {{ videoTimestampVisualization(assessmentForm.controls[dimension.name + '_value' + controlSuffix].value) }}
                                      </span>
                                    }
                                    @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required') && !sliderDisabled()) {
                                      <mat-error>
                                        <br><span>This field is required</span>
                                      </mat-error>
                                    }
                                  </div>
                                } @else {
                                  <div class="scale-interval">
                                    <mat-slider [min]="task.dimensionIntervalMinValues[documentIndex]"
                                      [max]="task.dimensionIntervalMaxValues[documentIndex]"
                                      [step]="dimension.scale.step"
                                      discrete>
                                      <input matSliderThumb
                                        formControlName="{{ dimension.name + '_value' + controlSuffix }}"
                                        (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)"
														   [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                  task.settings.countdown_behavior == 'disable_forms'">
                                      </mat-slider>
                                      @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value === '') {
                                        <span>
                                          Value: #
                                        </span>
                                      }
                                      @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value !== '') {
                                        <span>
                                          Value: {{ assessmentForm.controls[dimension.name + '_value' + controlSuffix].value }}
                                        </span>
                                      }
                                      @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required')) {
                                        <mat-error>
                                          <span>This field is required</span>
                                        </mat-error>
                                      }
                                    </div>
                                  }
                                  <!-- numeric slider -->
                                }
                                <!-- ─── Magnitude estimation ─── -->
                                @if (dimension.scale.type == 'magnitude_estimation') {
                                  <mat-form-field appearance="fill">
                                    <mat-label>Value</mat-label>
                                    <input matInput
                                      formControlName="{{ dimension.name + '_value' + controlSuffix }}"
                                      (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)"
                                      class="magnitude_estimation"
												   [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                              task.settings.countdown_behavior == 'disable_forms'">
                                      @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required')) {
                                        <mat-error>
                                          <span>This field is required</span>
                                        </mat-error>
                                      }
                                      @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'isNumber')) {
                                        <mat-error>
                                          <span>Value has to be a number (whole or decimal)</span>
                                        </mat-error>
                                      }
                                      @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'numberFormat')) {
                                        <mat-error>
                                          <span>Numbers must use dot as decimal separator (e.g. 1,234.56)</span>
                                        </mat-error>
                                      }
                                      @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'numberGreaterThan')) {
                                        <mat-error>
                                          <span>Value has to be greater than {{ dimension.scale.min }}</span>
                                        </mat-error>
                                      }
                                    </mat-form-field>
                                  }
                                }
                                <!-- ───── Horizontal layout (categorical implemented) ───── -->
                                @if (dimension.style.orientation == 'horizontal') {
                                  @if (dimension.scale.type == 'categorical') {
                                    <mat-radio-group formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                      @for (mapping of dimension.scale.mapping; track mapping) {
                                        <mat-radio-button
                                          class="radio-button"
                                          value="{{ mapping.value }}"
                                          (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)"
															  [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                         task.settings.countdown_behavior == 'disable_forms'">
                                          <span class="mapping-label">{{ mapping.label }}</span>
                                          @if (mapping.description) {
                                            <span>{{ ' (' + mapping.description + ')' }}</span>
                                          }
                                        </mat-radio-button>
                                      }
                                    </mat-radio-group>
                                  }
                                  <!-- horizontal interval / magnitude placeholders -->
                                  @if (dimension.scale.type == 'interval' || dimension.scale.type == 'magnitude_estimation') {
                                    <p i18n>TO BE IMPLEMENTED</p>
                                  }
                                }
                              </div>
                            </div>
                          }
                          <!-- ───────────── Justification ───────────── -->
                          @if (dimension.justification) {
                            <div class="dimension-container dimension-justification">
                              <div class="dimension-content justification">
                                <div class="dimension-text-field">
                                  <mat-form-field appearance="fill" class="width-100">
                                    <mat-label>{{ dimension.justification.text }}</mat-label>
                                    <textarea matInput
                                      rows="3"
                                      formControlName="{{ dimension.name + '_justification' + controlSuffix }}"
                                    (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, true)"></textarea>
                                    @if (utilsService.hasError(assessmentForm, dimension.name + '_justification' + controlSuffix, 'required')) {
                                      <mat-error>
                                        <span>This field is required</span>
                                      </mat-error>
                                    }
                                    @if (utilsService.hasError(assessmentForm, dimension.name + '_justification' + controlSuffix, 'longer')) {
                                      <mat-error>
                                        <span>This justification must have at least {{ dimension.justification.min_words }} words.</span>
                                      </mat-error>
                                    }
                                    @if (utilsService.hasError(assessmentForm, dimension.name + '_justification' + controlSuffix, 'invalid')) {
                                      <mat-error>
                                        <span>You cannot use the selected search-engine URL as part of the justification.</span>
                                      </mat-error>
                                    }
                                  </mat-form-field>
                                </div>
                              </div>
                            </div>
                          }
                        }
                      </div>
                    }
                    <!-- ───────────── MATRIX STYLE (skeleton placeholder) ───────────── -->
                    @if (dimension.style.type == 'matrix') {
                      <div>
                        <p i18n>TO BE IMPLEMENTED</p>
                      </div>
                    }
                  }
                  <!-- ───────────────────────────── PAIRWISE ───────────────────────────── -->
                  @if (dimension.pairwise) {
                    <!-- LIST-style pairwise -->
                    @if (dimension.style.type == 'list') {
                      <div class="dimension">
                        <!-- show only when previous pairwise step unlocked -->
                        @if (unlockNextDimension(documentIndex, dimension.index)) {
                          <div class="dimension-content-split">
                            <div class="dimension-name-center">
                              <mat-divider inset></mat-divider>
                              @if (!dimension.name_pretty) {
                                <h2>{{ utilsService.capitalize(dimension.name) }}</h2>
                              }
                              @if (dimension.name_pretty) {
                                <h2>{{ utilsService.capitalize(dimension.name_pretty) }}</h2>
                              }
                              <mat-divider inset></mat-divider>
                            </div>
                          </div>
                          @if (dimension.description) {
                            <div class="dimension-name-center">
                              <div class="dimension-split-inside">
                                <p>{{ dimension.description }}</p>
                                @if (dimension.example) {
                                  <i>{{ dimension.example }}</i>
                                }
                              </div>
                            </div>
                          }
                          <!-- search engine -->
                          <app-search-engine
                            [documentIndex]="documentIndex"
                            [dimensionIndex]="dimension.index"
                            [worker]="worker"
                            [searchEngineForms]="searchEngineForms"
                            [resultsRetrievedForms]="resultsRetrievedForms"
                            (formEmitter)="storeSearchEngineUrl($event, dimension.index)">
                          </app-search-engine>
                          <!-- scale controls -->
                          @if (dimension.scale) {
                            <div class="dimension-container dimension-scale">
                              <div class="dimension-content-split">
                                @if (dimension.style.orientation == 'vertical') {
                                  <!-- categorical vertical -->
                                  @if (dimension.scale.type == 'categorical') {
                                    @for (_ of task.documents[documentIndex].pairwise; track _; let k = $index) {
                                      <div class="dimension-split-inside dimension-box"
                                        >
                                        <p><span i18n>Answer for Element</span> {{ k }}</p>
                                        <mat-radio-group class="radio-button-group"
                                          formControlName="{{ dimension.name + '_value_element_' + k }}">
                                          @for (mapping of dimension.scale.mapping; track mapping) {
                                            <mat-radio-button
                                              class="radio-button"
                                              value="{{ mapping.value }}"
																  (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false);
                                                    updateDimensionValueSelection(documentIndex, dimension.index, k)"
																  [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                           task.settings.countdown_behavior == 'disable_forms'">
                                              <span class="mapping-label">{{ mapping.label }}</span>
                                              @if (mapping.description) {
                                                <span>{{ ' (' + mapping.description + ')' }}</span>
                                              }
                                            </mat-radio-button>
                                          }
                                        </mat-radio-group>
                                      </div>
                                    }
                                  }
                                  <!-- interval vertical -->
                                  @if (dimension.scale.type == 'interval') {
                                    @for (_ of task.documents[documentIndex].pairwise; track _; let k = $index) {
                                      <div class="dimension-split-inside dimension-box"
                                        >
                                        <p><span i18n>Answer for Element</span> {{ k }}</p>
                                        <label style="margin-left:10px;">
                                          <span i18n>Selected value:</span>
                                          {{ assessmentForm.controls[dimension.name + '_value_element_' + k].value }}
                                        </label>
                                        <mat-slider [min]="dimension.scale.min"
                                          [max]="dimension.scale.max"
                                          [step]="dimension.scale.step"
                                          discrete>
                                          <input matSliderThumb
                                            formControlName="{{ dimension.name + '_value_element_' + k }}"
													   (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false);
                                         updateDimensionValueSelection(documentIndex, dimension.index, k)"
													   [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                task.settings.countdown_behavior == 'disable_forms'">
                                          </mat-slider>
                                          @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'required')) {
                                            <mat-error>
                                              <span i18n>This field is required</span>
                                            </mat-error>
                                          }
                                        </div>
                                      }
                                    }
                                    <!-- magnitude estimation vertical -->
                                    @if (dimension.scale.type == 'magnitude_estimation') {
                                      @for (_ of task.documents[documentIndex].pairwise; track _; let k = $index) {
                                        <div class="dimension-split-inside dimension-box"
                                          >
                                          <p><span i18n>Answer for Element</span> {{ k }}</p>
                                          <mat-form-field appearance="fill" style="margin-left: 10px;">
                                            <mat-label><span i18n>Value</span></mat-label>
                                            <input matInput
                                              formControlName="{{ dimension.name + '_value_element_' + k }}"
													   (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false);
                                         updateDimensionValueSelection(documentIndex, dimension.index, k)"
                                              class="magnitude_estimation"
													   [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                task.settings.countdown_behavior == 'disable_forms'">
                                              @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'required')) {
                                                <mat-error>
                                                  <span i18n>This field is required</span>
                                                </mat-error>
                                              }
                                              @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'isNumber')) {
                                                <mat-error>
                                                  <span i18n>Value has to be a number (whole or decimal)</span>
                                                </mat-error>
                                              }
                                              @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'numberFormat')) {
                                                <mat-error>
                                                  <span i18n>Numbers must use dot as decimal separator</span>
                                                </mat-error>
                                              }
                                              @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'numberGreaterThan')) {
                                                <mat-error>
                                                  <span i18n>Value has to be greater than</span> {{ dimension.scale.min }}
                                                </mat-error>
                                              }
                                            </mat-form-field>
                                          </div>
                                        }
                                      }
                                    }
                                    <!-- horizontal pairwise placeholders -->
                                    @if (dimension.style.orientation == 'horizontal') {
                                      <p i18n>TO BE IMPLEMENTED</p>
                                    }
                                  </div>
                                </div>
                              }
                              <!-- pairwise justification -->
                              @if (dimension.justification) {
                                <div class="dimension-content-split">
                                  @for (_ of task.documents[documentIndex].pairwise; track _; let k = $index) {
                                    <div class="dimension-box"
                                      >
                                      <p><span i18n>Justification for Element</span> {{ k }}</p>
                                      <div class="dimension-text-field" style="margin-left: 10px;">
                                        <mat-form-field appearance="fill">
                                          <mat-label>{{ dimension.justification.text }}</mat-label>
                                          <textarea matInput
                                            rows="5"
                                            formControlName="{{ dimension.name + '_justification_element_' + k }}"
                                          (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, true)"></textarea>
                                          @if (utilsService.hasError(assessmentForm, dimension.name + '_justification_element_' + k, 'required')) {
                                            <mat-error>
                                              <span i18n>This field is required</span>
                                            </mat-error>
                                          }
                                          @if (utilsService.hasError(assessmentForm, dimension.name + '_justification_element_' + k, 'longer')) {
                                            <mat-error>
                                              <span i18n>This justification must have at least {{ dimension.justification.min_words }} words.</span>
                                            </mat-error>
                                          }
                                          @if (utilsService.hasError(assessmentForm, dimension.name + '_justification_element_' + k, 'invalid')) {
                                            <mat-error>
                                              <span i18n>You cannot use the selected search-engine URL as part of the justification.</span>
                                            </mat-error>
                                          }
                                        </mat-form-field>
                                      </div>
                                    </div>
                                  }
                                </div>
                              }
                            }
                          </div>
                        }
                        <!-- MATRIX-style pairwise placeholder -->
                        @if (dimension.style.type == 'matrix') {
                          <div class="dimension-matrix">
                            <p i18n>TO BE IMPLEMENTED</p>
                          </div>
                        }
                      }
                    </div>
                  }
                </form>
              </ng-template>


              <!-- ─────────────────── INITIAL (non-post) RENDERING ─────────────────── -->
              @if (!postAssessment) {
                <!-- iterate over positions & types -->
                @for (pos of ['top','middle','bottom']; track pos) {
                  @for (kind of ['list','matrix']; track kind) {
                    @if (assessmentForm &&
                      filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)).length > 0) {
                      <ng-template
                        [ngTemplateOutlet]="dimensionTemplate"
					[ngTemplateOutletContext]="{ dimensions: filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)),
                                     position: pos,
                                     assessmentForm: assessmentForm,
                                     controlSuffix: '' }">
                      </ng-template>
                    }
                  }
                }
              }

              <!-- ─────────────────── POST-ASSESSMENT RENDERING ─────────────────── -->
              @if (postAssessment && followingAssessmentAllowed) {
                @for (pos of ['top','middle','bottom']; track pos) {
                  @for (kind of ['list','matrix']; track kind) {
                    @if (assessmentFormAdditional &&
                      filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)).length > 0) {
                      <ng-template
                        [ngTemplateOutlet]="dimensionTemplate"
					[ngTemplateOutletContext]="{ dimensions: filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)),
                                     position: pos,
                                     assessmentForm: assessmentFormAdditional,
                                     controlSuffix: '_post_' + postAssessmentIndex }">
                      </ng-template>
                    }
                  }
                }
              }
