<!-- ────────────────────────────────────────────────────────────
     Re-usable template that prints a list of dimensions
     (works for both initial and post-assessment forms)
     ──────────────────────────────────────────────────────────── -->
<ng-template #dimensionTemplate
             let-dimensions="dimensions"
             let-position="position"
             let-assessmentForm="assessmentForm"
             let-controlSuffix="controlSuffix">
	<form [formGroup]="assessmentForm">

		<div *ngFor="let dimension of dimensions; let i = index" class="dimension">

			<!-- ───────────────────────────── NON-PAIRWISE ───────────────────────────── -->
			<ng-container *ngIf="!dimension.pairwise">

				<!-- ───────────── LIST STYLE ───────────── -->
				<div *ngIf="dimension.style.type == 'list'" class="dimension">

					<!-- Search-engine widget (optional) -->
					<app-search-engine
							[documentIndex]="documentIndex"
							[dimensionIndex]="dimension.index"
							[worker]="worker"
							[searchEngineForms]="searchEngineForms"
							[resultsRetrievedForms]="resultsRetrievedForms"
							(formEmitter)="storeSearchEngineUrl($event, dimension.index)">
					</app-search-engine>

					<ng-container *ngIf="verifyUrlSelection(position) && checkIfDimensionIsEnabledForPostAssessment(dimension.name)">

						<!-- Optional instructions -->
						<ng-container *ngIf="dimension.scale?.instructions as ins">
							<div class="evaluation-instructions">
								<!-- first time -->
								<ng-container *ngIf="!postAssessment">
									<h2>
										<span *ngIf="ins.label">{{ ins.label }} – </span>{{ ins.caption }}
									</h2>
								</ng-container>

								<!-- repetition -->
								<ng-container *ngIf="postAssessment && ins.labelRepetition && ins.captionRepetition">
									<h2>
										<span *ngIf="ins.labelRepetition">{{ ins.labelRepetition }} – </span>{{ ins.captionRepetition }}
									</h2>
								</ng-container>
							</div>
						</ng-container>

						<!-- Pretty name & description -->
						<div *ngIf="dimension.name_pretty" class="dimension-name">
							<h2>{{ utilsService.capitalize(dimension.name_pretty) }}</h2>
						</div>

						<div *ngIf="dimension.description" class="dimension-container dimension-description">
							<div class="dimension-content">
								<p>{{ dimension.description }}</p>
								<i class="dimension-example" *ngIf="dimension.example">{{ dimension.example }}</i>
							</div>
						</div>

						<!-- ───────────── SCALE CONTROLS ───────────── -->
						<div *ngIf="dimension.scale" class="dimension-container dimension-scale">
							<div class="dimension-content">

								<!-- ───── Vertical layout ───── -->
								<ng-container *ngIf="dimension.style.orientation == 'vertical'">

									<!-- ─── Categorical ─── -->
									<ng-container *ngIf="dimension.scale.type == 'categorical'">

										<!-- video special-case -->
										<ng-container *ngIf="isVideoTypeLabelCategorical(dimension); else normalCategorical">
											<mat-radio-group class="radio-button-group"
															 formControlName="{{ dimension.name + '_value' + controlSuffix }}">
												<ng-container *ngIf="!dimension.scale.multipleSelection">
													<ng-container *ngFor="let mapping of dimension.scale.mapping">
														<mat-divider *ngIf="mapping.separator" inset></mat-divider>
														<mat-radio-button
																value="{{ mapping.value }}"
																[disabled]="categoricalDimensionDisabled(dimension)"
																[attr.disabled]="task.countdownsExpired[documentIndex] && task.settings.countdown_behavior == 'disable_forms'"
																[ngClass]="mapping.separator ? 'radio-button radio-button-separated' : 'radio-button'"
																(change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)">
															<span class="mapping-label">{{ mapping.label }}</span>
															<span *ngIf="mapping.description">{{ ' (' + mapping.description + ')' }}</span>
														</mat-radio-button>
													</ng-container>
												</ng-container>

												<!-- multi-choice -->
												<div class="checkbox" *ngIf="dimension.scale.multipleSelection">
													<div formGroupName="{{ dimension.name + '_list' + controlSuffix }}">
														<div *ngFor="let mapping of dimension.scale.mapping; let k = index">
															<mat-checkbox formControlName="{{ k }}"
																		  (change)="handleCheckbox($event, dimension, k)">
																{{ mapping.label }}
															</mat-checkbox>
														</div>
													</div>
													<mat-form-field>
														<input matInput formControlName="{{ dimension.name + '_value' + controlSuffix }}">
													</mat-form-field>
												</div>
											</mat-radio-group>
										</ng-container>

										<!-- regular categorical -->
										<ng-template #normalCategorical>
											<mat-radio-group class="radio-button-group"
															 formControlName="{{ dimension.name + '_value' + controlSuffix }}">
												<ng-container *ngIf="!dimension.scale.multipleSelection">
													<ng-container *ngFor="let mapping of dimension.scale.mapping">
														<mat-divider *ngIf="mapping.separator" inset></mat-divider>
														<mat-radio-button
																value="{{ mapping.value }}"
																[attr.disabled]="task.countdownsExpired[documentIndex] && task.settings.countdown_behavior == 'disable_forms'"
																[ngClass]="mapping.separator ? 'radio-button radio-button-separated' : 'radio-button'"
																(change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false); detectCategoricalDimensionOnChange($event)">
															<span class="mapping-label">{{ mapping.label }}</span>
															<span *ngIf="mapping.description">{{ ' (' + mapping.description + ')' }}</span>
														</mat-radio-button>
													</ng-container>
												</ng-container>

												<!-- multi-choice -->
												<div class="checkbox" *ngIf="dimension.scale.multipleSelection">
													<div formGroupName="{{ dimension.name + '_list' + controlSuffix }}">
														<div *ngFor="let mapping of dimension.scale.mapping; let k = index">
															<mat-checkbox formControlName="{{ k }}"
																		  (change)="handleCheckbox($event, dimension, k)">
																{{ mapping.label }}
															</mat-checkbox>
														</div>
													</div>
													<mat-form-field>
														<input matInput formControlName="{{ dimension.name + '_value' + controlSuffix }}">
													</mat-form-field>
												</div>
											</mat-radio-group>
										</ng-template>
									</ng-container>

									<!-- ─── Interval ─── -->
									<ng-container *ngIf="dimension.scale.type == 'interval'">

										<!-- video timestamp slider -->
										<ng-container *ngIf="isVideoTimestampInterval(); else numericInterval">
											<div class="scale-interval">
												<mat-slider [disabled]="sliderDisabled()"
															[min]="task.dimensionIntervalMinValues[documentIndex]"
															[max]="task.dimensionIntervalMaxValues[documentIndex]"
															[step]="dimension.scale.step">
													<input matSliderThumb
														   formControlName="{{ dimension.name + '_value' + controlSuffix }}"
														   (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)"
														   [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                  task.settings.countdown_behavior == 'disable_forms'">
												</mat-slider>

												<span *ngIf="assessmentForm.controls[dimension.name + '_value' + controlSuffix].value === ''">
                          Value: 00:00.00
                        </span>
												<span *ngIf="assessmentForm.controls[dimension.name + '_value' + controlSuffix].value !== ''">
                          Value:
													{{ videoTimestampVisualization(assessmentForm.controls[dimension.name + '_value' + controlSuffix].value) }}
                        </span>

												<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required') && !sliderDisabled()">
													<br><span>This field is required</span>
												</mat-error>
											</div>
										</ng-container>

										<!-- numeric slider -->
										<ng-template #numericInterval>
											<div class="scale-interval">
												<mat-slider [min]="task.dimensionIntervalMinValues[documentIndex]"
															[max]="task.dimensionIntervalMaxValues[documentIndex]"
															[step]="dimension.scale.step"
															discrete>
													<input matSliderThumb
														   formControlName="{{ dimension.name + '_value' + controlSuffix }}"
														   (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)"
														   [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                  task.settings.countdown_behavior == 'disable_forms'">
												</mat-slider>
												<span *ngIf="assessmentForm.controls[dimension.name + '_value' + controlSuffix].value === ''">
                          Value: #
                        </span>
												<span *ngIf="assessmentForm.controls[dimension.name + '_value' + controlSuffix].value !== ''">
                          Value: {{ assessmentForm.controls[dimension.name + '_value' + controlSuffix].value }}
                        </span>

												<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required')">
													<span>This field is required</span>
												</mat-error>
											</div>
										</ng-template>
									</ng-container>

									<!-- ─── Magnitude estimation ─── -->
									<ng-container *ngIf="dimension.scale.type == 'magnitude_estimation'">
										<mat-form-field appearance="fill">
											<mat-label>Value</mat-label>
											<input matInput
												   formControlName="{{ dimension.name + '_value' + controlSuffix }}"
												   (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)"
												   class="magnitude_estimation"
												   [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                              task.settings.countdown_behavior == 'disable_forms'">

											<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required')">
												<span>This field is required</span>
											</mat-error>
											<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'isNumber')">
												<span>Value has to be a number (whole or decimal)</span>
											</mat-error>
											<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'numberFormat')">
												<span>Numbers must use dot as decimal separator (e.g. 1,234.56)</span>
											</mat-error>
											<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'numberGreaterThan')">
												<span>Value has to be greater than {{ dimension.scale.min }}</span>
											</mat-error>
										</mat-form-field>
									</ng-container>

								</ng-container>

								<!-- ───── Horizontal layout (categorical implemented) ───── -->
								<ng-container *ngIf="dimension.style.orientation == 'horizontal'">
									<ng-container *ngIf="dimension.scale.type == 'categorical'">
										<mat-radio-group formControlName="{{ dimension.name + '_value' + controlSuffix }}">
											<mat-radio-button *ngFor="let mapping of dimension.scale.mapping"
															  class="radio-button"
															  value="{{ mapping.value }}"
															  (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)"
															  [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                         task.settings.countdown_behavior == 'disable_forms'">
												<span class="mapping-label">{{ mapping.label }}</span>
												<span *ngIf="mapping.description">{{ ' (' + mapping.description + ')' }}</span>
											</mat-radio-button>
										</mat-radio-group>
									</ng-container>

									<!-- horizontal interval / magnitude placeholders -->
									<ng-container *ngIf="dimension.scale.type == 'interval' || dimension.scale.type == 'magnitude_estimation'">
										<p i18n>TO BE IMPLEMENTED</p>
									</ng-container>
								</ng-container>

							</div>
						</div>

						<!-- ───────────── Justification ───────────── -->
						<div *ngIf="dimension.justification" class="dimension-container dimension-justification">
							<div class="dimension-content justification">
								<div class="dimension-text-field">
									<mat-form-field appearance="fill" class="width-100">
										<mat-label>{{ dimension.justification.text }}</mat-label>
										<textarea matInput
												  rows="3"
												  formControlName="{{ dimension.name + '_justification' + controlSuffix }}"
												  (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, true)"></textarea>

										<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_justification' + controlSuffix, 'required')">
											<span>This field is required</span>
										</mat-error>
										<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_justification' + controlSuffix, 'longer')">
											<span>This justification must have at least {{ dimension.justification.min_words }} words.</span>
										</mat-error>
										<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_justification' + controlSuffix, 'invalid')">
											<span>You cannot use the selected search-engine URL as part of the justification.</span>
										</mat-error>
									</mat-form-field>
								</div>
							</div>
						</div>

					</ng-container>
				</div>

				<!-- ───────────── MATRIX STYLE (skeleton placeholder) ───────────── -->
				<div *ngIf="dimension.style.type == 'matrix'">
					<p i18n>TO BE IMPLEMENTED</p>
				</div>

			</ng-container>

			<!-- ───────────────────────────── PAIRWISE ───────────────────────────── -->
			<ng-container *ngIf="dimension.pairwise">

				<!-- LIST-style pairwise -->
				<div *ngIf="dimension.style.type == 'list'" class="dimension">

					<!-- show only when previous pairwise step unlocked -->
					<ng-container *ngIf="unlockNextDimension(documentIndex, dimension.index)">

						<div class="dimension-content-split">
							<div class="dimension-name-center">
								<mat-divider inset></mat-divider>
								<h2 *ngIf="!dimension.name_pretty">{{ utilsService.capitalize(dimension.name) }}</h2>
								<h2 *ngIf="dimension.name_pretty">{{ utilsService.capitalize(dimension.name_pretty) }}</h2>
								<mat-divider inset></mat-divider>
							</div>
						</div>

						<div *ngIf="dimension.description" class="dimension-name-center">
							<div class="dimension-split-inside">
								<p>{{ dimension.description }}</p>
								<i *ngIf="dimension.example">{{ dimension.example }}</i>
							</div>
						</div>

						<!-- search engine -->
						<app-search-engine
								[documentIndex]="documentIndex"
								[dimensionIndex]="dimension.index"
								[worker]="worker"
								[searchEngineForms]="searchEngineForms"
								[resultsRetrievedForms]="resultsRetrievedForms"
								(formEmitter)="storeSearchEngineUrl($event, dimension.index)">
						</app-search-engine>

						<!-- scale controls -->
						<div *ngIf="dimension.scale" class="dimension-container dimension-scale">
							<div class="dimension-content-split">

								<ng-container *ngIf="dimension.style.orientation == 'vertical'">

									<!-- categorical vertical -->
									<ng-container *ngIf="dimension.scale.type == 'categorical'">
										<div class="dimension-split-inside dimension-box"
											 *ngFor="let _ of task.documents[documentIndex].pairwise; let k = index">
											<p><span i18n>Answer for Element</span> {{ k }}</p>

											<mat-radio-group class="radio-button-group"
															 formControlName="{{ dimension.name + '_value_element_' + k }}">
												<mat-radio-button *ngFor="let mapping of dimension.scale.mapping"
																  class="radio-button"
																  value="{{ mapping.value }}"
																  (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false);
                                                    updateDimensionValueSelection(documentIndex, dimension.index, k)"
																  [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                           task.settings.countdown_behavior == 'disable_forms'">
													<span class="mapping-label">{{ mapping.label }}</span>
													<span *ngIf="mapping.description">{{ ' (' + mapping.description + ')' }}</span>
												</mat-radio-button>
											</mat-radio-group>
										</div>
									</ng-container>

									<!-- interval vertical -->
									<ng-container *ngIf="dimension.scale.type == 'interval'">
										<div class="dimension-split-inside dimension-box"
											 *ngFor="let _ of task.documents[documentIndex].pairwise; let k = index">
											<p><span i18n>Answer for Element</span> {{ k }}</p>

											<label style="margin-left:10px;">
												<span i18n>Selected value:</span>
												{{ assessmentForm.controls[dimension.name + '_value_element_' + k].value }}
											</label>

											<mat-slider [min]="dimension.scale.min"
														[max]="dimension.scale.max"
														[step]="dimension.scale.step"
														discrete>
												<input matSliderThumb
													   formControlName="{{ dimension.name + '_value_element_' + k }}"
													   (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false);
                                         updateDimensionValueSelection(documentIndex, dimension.index, k)"
													   [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                task.settings.countdown_behavior == 'disable_forms'">
											</mat-slider>

											<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'required')">
												<span i18n>This field is required</span>
											</mat-error>
										</div>
									</ng-container>

									<!-- magnitude estimation vertical -->
									<ng-container *ngIf="dimension.scale.type == 'magnitude_estimation'">
										<div class="dimension-split-inside dimension-box"
											 *ngFor="let _ of task.documents[documentIndex].pairwise; let k = index">
											<p><span i18n>Answer for Element</span> {{ k }}</p>

											<mat-form-field appearance="fill" style="margin-left: 10px;">
												<mat-label><span i18n>Value</span></mat-label>
												<input matInput
													   formControlName="{{ dimension.name + '_value_element_' + k }}"
													   (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false);
                                         updateDimensionValueSelection(documentIndex, dimension.index, k)"
													   class="magnitude_estimation"
													   [attr.disabled]="task.countdownsExpired[documentIndex] &&
                                                task.settings.countdown_behavior == 'disable_forms'">

												<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'required')">
													<span i18n>This field is required</span>
												</mat-error>
												<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'isNumber')">
													<span i18n>Value has to be a number (whole or decimal)</span>
												</mat-error>
												<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'numberFormat')">
													<span i18n>Numbers must use dot as decimal separator</span>
												</mat-error>
												<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'numberGreaterThan')">
													<span i18n>Value has to be greater than</span> {{ dimension.scale.min }}
												</mat-error>
											</mat-form-field>
										</div>
									</ng-container>

								</ng-container>

								<!-- horizontal pairwise placeholders -->
								<ng-container *ngIf="dimension.style.orientation == 'horizontal'">
									<p i18n>TO BE IMPLEMENTED</p>
								</ng-container>

							</div>
						</div>

						<!-- pairwise justification -->
						<div *ngIf="dimension.justification" class="dimension-content-split">
							<div class="dimension-box"
								 *ngFor="let _ of task.documents[documentIndex].pairwise; let k = index">

								<p><span i18n>Justification for Element</span> {{ k }}</p>

								<div class="dimension-text-field" style="margin-left: 10px;">
									<mat-form-field appearance="fill">
										<mat-label>{{ dimension.justification.text }}</mat-label>
										<textarea matInput
												  rows="5"
												  formControlName="{{ dimension.name + '_justification_element_' + k }}"
												  (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, true)"></textarea>

										<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_justification_element_' + k, 'required')">
											<span i18n>This field is required</span>
										</mat-error>
										<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_justification_element_' + k, 'longer')">
											<span i18n>This justification must have at least {{ dimension.justification.min_words }} words.</span>
										</mat-error>
										<mat-error *ngIf="utilsService.hasError(assessmentForm, dimension.name + '_justification_element_' + k, 'invalid')">
											<span i18n>You cannot use the selected search-engine URL as part of the justification.</span>
										</mat-error>
									</mat-form-field>
								</div>
							</div>
						</div>

					</ng-container>
				</div>

				<!-- MATRIX-style pairwise placeholder -->
				<div *ngIf="dimension.style.type == 'matrix'" class="dimension-matrix">
					<p i18n>TO BE IMPLEMENTED</p>
				</div>
			</ng-container>

		</div>
	</form>
</ng-template>


<!-- ─────────────────── INITIAL (non-post) RENDERING ─────────────────── -->
<ng-container *ngIf="!postAssessment">
	<!-- iterate over positions & types -->
	<ng-container *ngFor="let pos of ['top','middle','bottom']">
		<ng-container *ngFor="let kind of ['list','matrix']">
			<ng-template
					*ngIf="assessmentForm &&
               filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)).length > 0"
					[ngTemplateOutlet]="dimensionTemplate"
					[ngTemplateOutletContext]="{ dimensions: filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)),
                                     position: pos,
                                     assessmentForm: assessmentForm,
                                     controlSuffix: '' }">
			</ng-template>
		</ng-container>
	</ng-container>
</ng-container>

<!-- ─────────────────── POST-ASSESSMENT RENDERING ─────────────────── -->
<ng-container *ngIf="postAssessment && followingAssessmentAllowed">
	<ng-container *ngFor="let pos of ['top','middle','bottom']">
		<ng-container *ngFor="let kind of ['list','matrix']">
			<ng-template
					*ngIf="assessmentFormAdditional &&
               filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)).length > 0"
					[ngTemplateOutlet]="dimensionTemplate"
					[ngTemplateOutletContext]="{ dimensions: filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)),
                                     position: pos,
                                     assessmentForm: assessmentFormAdditional,
                                     controlSuffix: '_post_' + postAssessmentIndex }">
			</ng-template>
		</ng-container>
	</ng-container>
</ng-container>
