<!-- ────────────────────────────────────────────────────────────
     Re-usable template that renders a batch of dimensions.
     Works for both INITIAL and POST forms via 'assessmentForm' + 'controlSuffix'.
     Notes:
       - verifyUrlSelection(position) is now doc-aware (checks only dims applicable to CURRENT doc)
       - Post-step gate is applied ONLY when postAssessment is true
       - Uses helper subdocs(documentIndex) to safely read optional 'subdocuments' (returns [])
     ──────────────────────────────────────────────────────────── -->
<ng-template
    #dimensionTemplate
    let-dimensions="dimensions"
    let-position="position"
    let-assessmentForm="assessmentForm"
    let-controlSuffix="controlSuffix">

    <form [formGroup]="assessmentForm">
        @for (dimension of dimensions; track dimension; let i = $index) {
            <div class="dimension">

                <!-- ───────────────────────────── NON-PAIRWISE (POINTWISE) ───────────────────────────── -->
                @if (!dimension.pairwise) {

                    <!-- ───────────── LIST STYLE ───────────── -->
                    @if (dimension.style.type == 'list') {
                        <div class="dimension dimension--pointwise">

                            <app-search-engine
                                [documentIndex]="documentIndex"
                                [dimensionIndex]="dimension.index"
                                [worker]="worker"
                                [searchEngineForms]="searchEngineForms"
                                [resultsRetrievedForms]="resultsRetrievedForms"
                                (formEmitter)="storeSearchEngineUrl($event, dimension.index)">
                            </app-search-engine>

                            @if (verifyUrlSelection(position) && (!postAssessment || checkIfDimensionIsEnabledForPostAssessment(dimension.name))) {

                                @if (dimension.scale?.instructions; as ins) {
                                    @if (ins) {
                                        <app-instruction-list
                                            [element]="{
                                              label:   (postAssessment && ins.labelRepetition && ins.captionRepetition) ? ins.labelRepetition : ins.label,
                                              caption: (postAssessment && ins.labelRepetition && ins.captionRepetition) ? ins.captionRepetition : ins.caption,
                                              text: ins.text
                                            }">
                                        </app-instruction-list>
                                    }
                                }

                                @if (dimension.name_pretty) {
                                    <div class="dimension-name">
                                        <h2>{{ utilsService.capitalize(dimension.name_pretty) }}</h2>
                                    </div>
                                }

                                @if (dimension.description || dimension.example) {
                                    <div class="dimension-container dimension-description">
                                        <div class="dimension-content">
                                            @if (dimension.description) {
                                                <p>{{ dimension.description }}</p>
                                            }
                                            @if (dimension.example) {
                                                <i class="dimension-example">{{ dimension.example }}</i>
                                            }
                                        </div>
                                    </div>
                                }

                                @if (dimension.scale) {
                                    <div class="dimension-container dimension-scale">
                                        <div class="dimension-content">

                                            @if (dimension.style.orientation == 'vertical') {

                                                <!-- Categorical (two branches kept) -->
                                                @if (dimension.scale.type == 'categorical') {

                                                    @if (isVideoTypeLabelCategorical(dimension)) {
                                                        <mat-radio-group class="radio-button-group" formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                                            @if (!dimension.scale.multipleSelection) {
                                                                @for (mapping of dimension.scale.mapping; track mapping) {
                                                                    @if (mapping.separator) {
                                                                        <mat-divider inset></mat-divider>
                                                                    }
                                                                    <mat-radio-button
                                                                        class="radio-button"
                                                                        value="{{ mapping.value }}"
                                                                        (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)">
                                                                        <span class="mapping-label">{{ mapping.label }}</span>
                                                                        @if (mapping.description) {
                                                                            <span>{{ ' (' + mapping.description + ')' }}</span>
                                                                        }
                                                                    </mat-radio-button>
                                                                }
                                                            }
                                                            @if (dimension.scale.multipleSelection) {
                                                                <div class="checkbox">
                                                                    <div formGroupName="{{ dimension.name + '_list' + controlSuffix }}">
                                                                        @for (mapping of dimension.scale.mapping; track mapping; let k = $index) {
                                                                            <div>
                                                                                <mat-checkbox formControlName="{{ k }}" (change)="handleCheckbox($event, dimension, k)">
                                                                                    {{ mapping.label }}
                                                                                </mat-checkbox>
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                    <mat-form-field>
                                                                        <input matInput formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                                                    </mat-form-field>
                                                                </div>
                                                            }
                                                        </mat-radio-group>

                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required')
                                                        && shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix)
                                                        && assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>This field is required</span></mat-error>
                                                        }
                                                    } @else {
                                                        <mat-radio-group class="radio-button-group" formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                                            @if (!dimension.scale.multipleSelection) {
                                                                @for (mapping of dimension.scale.mapping; track mapping) {
                                                                    @if (mapping.separator) {
                                                                        <mat-divider inset></mat-divider>
                                                                    }
                                                                    <mat-radio-button
                                                                        class="radio-button"
                                                                        value="{{ mapping.value }}"
                                                                        (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false); detectCategoricalDimensionOnChange($event)">
                                                                        <span class="mapping-label">{{ mapping.label }}</span>
                                                                        @if (mapping.description) {
                                                                            <span>{{ ' (' + mapping.description + ')' }}</span>
                                                                        }
                                                                    </mat-radio-button>
                                                                }
                                                            }
                                                            @if (dimension.scale.multipleSelection) {
                                                                <div class="checkbox">
                                                                    <div formGroupName="{{ dimension.name + '_list' + controlSuffix }}">
                                                                        @for (mapping of dimension.scale.mapping; track mapping; let k = $index) {
                                                                            <div>
                                                                                <mat-checkbox formControlName="{{ k }}" (change)="handleCheckbox($event, dimension, k)">
                                                                                    {{ mapping.label }}
                                                                                </mat-checkbox>
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                    <mat-form-field>
                                                                        <input matInput formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                                                    </mat-form-field>
                                                                </div>
                                                            }
                                                        </mat-radio-group>

                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required')
                                                        && shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix)
                                                        && assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>This field is required</span></mat-error>
                                                        }
                                                    }
                                                }

                                                <!-- Interval -->
                                                @if (dimension.scale.type == 'interval') {
                                                    @if (isVideoTimestampInterval()) {
                                                        <div class="scale-interval">
                                                            <mat-slider
                                                                [min]="task.dimensionIntervalMinValues[documentIndex]"
                                                                [max]="task.dimensionIntervalMaxValues[documentIndex]"
                                                                [step]="dimension.scale.step">
                                                                <input
                                                                    matSliderThumb
                                                                    formControlName="{{ dimension.name + '_value' + controlSuffix }}"
                                                                    (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)">
                                                            </mat-slider>

                                                            @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value == null || assessmentForm.controls[dimension.name + '_value' + controlSuffix].value === '') {
                                                                <span>Value: 00:00.00</span>
                                                            }
                                                            @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value != null && assessmentForm.controls[dimension.name + '_value' + controlSuffix].value !== '') {
                                                                <span>Value: {{ videoTimestampVisualization(assessmentForm.controls[dimension.name + '_value' + controlSuffix].value) }}</span>
                                                            }

                                                            @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required')
                                                            && shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix)
                                                            && assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                                <mat-error><br><span>This field is required</span></mat-error>
                                                            }
                                                        </div>
                                                    } @else {
                                                        <div class="scale-interval">
                                                            <mat-slider
                                                                [min]="dimension.scale.min"
                                                                [max]="dimension.scale.max"
                                                                [step]="dimension.scale.step"
                                                                discrete="true">
                                                                <input
                                                                    matSliderThumb
                                                                    formControlName="{{ dimension.name + '_value' + controlSuffix }}"
                                                                    (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)">
                                                            </mat-slider>

                                                            @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value == null || assessmentForm.controls[dimension.name + '_value' + controlSuffix].value === '') {
                                                                <span>Value: #</span>
                                                            }
                                                            @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value != null && assessmentForm.controls[dimension.name + '_value' + controlSuffix].value !== '') {
                                                                <span>Value: {{ assessmentForm.controls[dimension.name + '_value' + controlSuffix].value }}</span>
                                                            }

                                                            @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required')
                                                            && shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix)
                                                            && assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                                <mat-error><span>This field is required</span></mat-error>
                                                            }
                                                        </div>
                                                    }
                                                }

                                                <!-- Magnitude estimation -->
                                                @if (dimension.scale.type == 'magnitude_estimation') {
                                                    <mat-form-field appearance="fill">
                                                        <mat-label>Value</mat-label>
                                                        <input
                                                            matInput
                                                            formControlName="{{ dimension.name + '_value' + controlSuffix }}"
                                                            (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)"
                                                            class="magnitude_estimation">

                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required')
                                                        && shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix)
                                                        && assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>This field is required</span></mat-error>
                                                        }
                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'isNumber')
                                                        && shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix)
                                                        && assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>Value has to be a number (whole or decimal)</span></mat-error>
                                                        }
                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'numberFormat')
                                                        && shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix)
                                                        && assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>Numbers must use dot as decimal separator (e.g. 1,234.56)</span></mat-error>
                                                        }
                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'numberGreaterThan')
                                                        && shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix)
                                                        && assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>Value has to be greater than {{ dimension.scale.min }}</span></mat-error>
                                                        }
                                                    </mat-form-field>
                                                }
                                            }

                                            @if (dimension.style.orientation == 'horizontal') {
                                                @if (dimension.scale.type == 'categorical') {
                                                    <mat-radio-group formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                                        @for (mapping of dimension.scale.mapping; track mapping) {
                                                            <mat-radio-button
                                                                class="radio-button"
                                                                value="{{ mapping.value }}"
                                                                (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)">
                                                                <span class="mapping-label">{{ mapping.label }}</span>
                                                                @if (mapping.description) {
                                                                    <span>{{ ' (' + mapping.description + ')' }}</span>
                                                                }
                                                            </mat-radio-button>
                                                        }
                                                    </mat-radio-group>
                                                    @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required')
                                                    && shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix)
                                                    && assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                        <mat-error><span>This field is required</span></mat-error>
                                                    }
                                                }
                                                @if (dimension.scale.type == 'interval' || dimension.scale.type == 'magnitude_estimation') {
                                                    <p i18n>TO BE IMPLEMENTED</p>
                                                }
                                            }
                                        </div>
                                    </div>
                                }

                                @if (dimension.justification) {
                                    <app-justification-field
                                        [form]="assessmentForm"
                                        [controlName]="dimension.name + '_justification' + controlSuffix"
                                        [label]="dimension.justification.text"
                                        [rows]="3"
                                        [minWords]="dimension.justification.min_words"
                                        [showCounter]="true"
                                        [submitted]="submitted"
                                        [documentIndex]="documentIndex"
                                        [dimensionIndex]="dimension.index"
                                        [postAssessmentIndex]="postAssessmentIndex">
                                    </app-justification-field>
                                }
                            }
                        </div>
                    }

                    <!-- ───────────── MATRIX STYLE ───────────── -->
                    @if (dimension.style.type == 'matrix') {
                        <div class="dimension dimension--pointwise">

                            <app-search-engine
                                [documentIndex]="documentIndex"
                                [dimensionIndex]="dimension.index"
                                [worker]="worker"
                                [searchEngineForms]="searchEngineForms"
                                [resultsRetrievedForms]="resultsRetrievedForms"
                                (formEmitter)="storeSearchEngineUrl($event, dimension.index)">
                            </app-search-engine>

                            @if (verifyUrlSelection(position) && (!postAssessment || checkIfDimensionIsEnabledForPostAssessment(dimension.name))) {

                                <div class="{{ (dimensions.length === 1) ? 'dimension-matrix dimension-matrix-single' : 'dimension-matrix dimension-matrix-multiple' }}">

                                    @let ins = dimension.scale?.instructions;
                                    @if (ins) {
                                        <app-instruction-list
                                            [element]="postAssessment
                                              ? { label: ins.labelRepetition || ins.label,
                                                  caption: ins.captionRepetition || ins.caption,
                                                  text: ins.text }
                                              : { label: ins.label,
                                                  caption: ins.caption,
                                                  text: ins.text }">
                                        </app-instruction-list>
                                    }

                                    <!-- Header row once, from first dimension with scale.mapping -->
                                    @let headerDim = getFirstMatrixDimensionWithScale(dimensions);
                                    @if (dimension === headerDim) {
                                        <div
                                            class="matrix-header matrix-grid"
                                            [style.--cols]="headerDim.scale.mapping.length"
                                            [style.--col-name]="'180px'"
                                            [style.--col-desc]="'320px'">

                                            <div class="matrix-cell matrix-stub"></div>
                                            <div class="matrix-cell matrix-stub"></div>

                                            @for (mapping of headerDim.scale.mapping; track mapping) {
                                                <div class="matrix-cell matrix-header-cell">
                                                    @if (mapping.label) {
                                                        <div class="mapping-label"><strong [innerHTML]="mapping.label"></strong></div>
                                                    }
                                                    @if (mapping.description) {
                                                        <div><span> ({{ mapping.description }})</span></div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }

                                    <!-- Optional divider above row -->
                                    @if (dimension.style?.separator) {
                                        <div class="matrix-row-separator">
                                            <mat-divider></mat-divider>
                                        </div>
                                    }

                                    <!-- Matrix row uses HEADER columns; fill gaps with placeholders -->
                                    @if (dimension.scale) {
                                        <mat-radio-group
                                            class="matrix-row matrix-grid"
                                            [style.--cols]="headerDim?.scale?.mapping?.length || 0"
                                            [style.--col-name]="'180px'"
                                            [style.--col-desc]="'320px'"
                                            formControlName="{{ dimension.name + '_value' + controlSuffix }}">

                                            <div class="matrix-cell matrix-name">
                                                @if (dimension.name_pretty) {
                                                    <p><strong>{{ dimension.name_pretty }}</strong></p>
                                                }
                                                @if (!dimension.name_pretty) {
                                                    <p><strong>{{ dimension.name }}</strong></p>
                                                }
                                            </div>

                                            <div class="matrix-cell matrix-desc">
                                                @if (dimension.description) {
                                                    <div class="{{ dimension.example ? '' : 'description-sub' }}"><p>{{ dimension.description }}</p></div>
                                                }
                                                @if (dimension.example) {
                                                    <div class="description-sub"><i>{{ dimension.example }}</i></div>
                                                }
                                            </div>

                                            @for (hdrMap of headerDim?.scale?.mapping; track hdrMap; let col = $index) {
                                                @let rowMap = (dimension.scale?.mapping && dimension.scale.mapping.length > col) ? dimension.scale.mapping[col] : null;

                                                <div class="matrix-cell matrix-value-control">
                                                    @if (rowMap) {
                                                        <mat-radio-button
                                                            class="radio-button matrix-radio"
                                                            [value]="rowMap.value"
                                                            [attr.aria-label]="rowMap.label || ('Option ' + col)"
                                                            [disableRipple]="true"
                                                            (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)">
                                                        </mat-radio-button>
                                                    } @else {
                                                        <span class="matrix-placeholder" aria-hidden="true"></span>
                                                    }
                                                </div>
                                            }
                                        </mat-radio-group>

                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required')
                                        && shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix)
                                        && assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                            <mat-error><span i18n>This field is required</span></mat-error>
                                        }
                                    }
                                </div>

                                @if (dimension.justification) {
                                    <app-justification-field
                                        [form]="assessmentForm"
                                        [controlName]="dimension.name + '_justification' + controlSuffix"
                                        [label]="dimension.justification.text"
                                        [rows]="5"
                                        [minWords]="dimension.justification.min_words"
                                        [showCounter]="true"
                                        [submitted]="submitted"
                                        [documentIndex]="documentIndex"
                                        [dimensionIndex]="dimension.index"
                                        [postAssessmentIndex]="postAssessmentIndex">
                                    </app-justification-field>
                                }
                            }
                        </div>
                    }
                }
                <!-- ───────────────────────────── PAIRWISE ───────────────────────────── -->
                @if (dimension.pairwise) {

                    <!-- LIST-style pairwise -->
                    @if (dimension.style.type == 'list') {
                        <div class="dimension">

                            <!-- Unlock pairwise row only after required selections -->
                            @if (unlockNextDimension(documentIndex, dimension.index)) {

                                <div class="dimension-name-center">
                                    @if (!dimension.name_pretty) {
                                        <h2>{{ utilsService.capitalize(dimension.name) }}</h2>
                                    }
                                    @if (dimension.name_pretty) {
                                        <h2>{{ utilsService.capitalize(dimension.name_pretty) }}</h2>
                                    }
                                </div>

                                @if (dimension.description || dimension.example) {
                                    <div class="dimension-name-center">
                                        <div class="dimension-split-inside">
                                            @if (dimension.description) {
                                                <p>{{ dimension.description }}</p>
                                            }
                                            @if (dimension.example) {
                                                <i>{{ dimension.example }}</i>
                                            }
                                        </div>
                                    </div>
                                }

                                <!-- Pairwise instructions via shared component -->
                                @if (dimension.scale?.instructions; as ins) {
                                    <app-instruction-list [element]="ins"></app-instruction-list>
                                }

                                <app-search-engine
                                    [documentIndex]="documentIndex"
                                    [dimensionIndex]="dimension.index"
                                    [worker]="worker"
                                    [searchEngineForms]="searchEngineForms"
                                    [resultsRetrievedForms]="resultsRetrievedForms"
                                    (formEmitter)="storeSearchEngineUrl($event, dimension.index)">
                                </app-search-engine>

                                @if (dimension.scale) {
                                    <div class="dimension-container dimension-scale">
                                        <div class="dimension-content-split pairwise-columns">

                                            <div class="pairwise-column-title"><strong>Element A</strong></div>
                                            <div class="pairwise-column-title"><strong>Element B</strong></div>

                                            @if (dimension.style.orientation == 'vertical') {

                                                <!-- Pairwise categorical -->
                                                @if (dimension.scale.type == 'categorical') {
                                                    <!-- Safe accessor: subdocs(documentIndex) returns [] when 'subdocuments' is missing -->
                                                    @for (subdoc of getSubdocumentsHelper(documentIndex); track subdoc; let k = $index) {
                                                        <div class="dimension-split-inside dimension-box pairwise-col-surface">
                                                            <mat-radio-group
                                                                class="radio-button-group"
                                                                formControlName="{{ dimension.name + '_value_element_' + k }}">
                                                                @for (mapping of dimension.scale.mapping; track mapping) {
                                                                    <mat-radio-button
                                                                        class="radio-button"
                                                                        value="{{ mapping.value }}"
                                                                        (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false); updateDimensionValueSelection(documentIndex, dimension.index, k)">
                                                                        <span class="mapping-label">{{ mapping.label }}</span>
                                                                        @if (mapping.description) {
                                                                            <span>{{ ' (' + mapping.description + ')' }}</span>
                                                                        }
                                                                    </mat-radio-button>
                                                                }
                                                            </mat-radio-group>
                                                            @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'required') &&
                                                            shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                            assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                <mat-error><span i18n>This field is required</span></mat-error>
                                                            }
                                                        </div>
                                                    }
                                                }

                                                <!-- Pairwise interval -->
                                                @if (dimension.scale.type == 'interval') {
                                                    <!-- Safe accessor: subdocs(documentIndex) returns [] when 'subdocuments' is missing -->
                                                    @for (subdoc of getSubdocumentsHelper(documentIndex); track subdoc; let k = $index) {
                                                        <div class="dimension-split-inside dimension-box pairwise-col-surface">
                                                            <label class="pairwise-inline-label">
                                                                <span i18n>Selected value:</span>
                                                                {{ assessmentForm.controls[dimension.name + '_value_element_' + k].value }}
                                                            </label>
                                                            <mat-slider
                                                                [min]="dimension.scale.min"
                                                                [max]="dimension.scale.max"
                                                                [step]="dimension.scale.step"
                                                                discrete="true">
                                                                <input
                                                                    matSliderThumb
                                                                    formControlName="{{ dimension.name + '_value_element_' + k }}"
                                                                    (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false); updateDimensionValueSelection(documentIndex, dimension.index, k)">
                                                            </mat-slider>
                                                            @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'required') &&
                                                            shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                            assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                <mat-error><span i18n>This field is required</span></mat-error>
                                                            }
                                                        </div>
                                                    }
                                                }

                                                <!-- Pairwise magnitude estimation -->
                                                @if (dimension.scale.type == 'magnitude_estimation') {
                                                    <!-- Safe accessor: subdocs(documentIndex) returns [] when 'subdocuments' is missing -->
                                                    @for (subdoc of getSubdocumentsHelper(documentIndex); track subdoc; let k = $index) {
                                                        <div class="dimension-split-inside dimension-box pairwise-col-surface">
                                                            <mat-form-field appearance="fill" class="pairwise-magnitude-field">
                                                                <mat-label><span i18n>Value</span></mat-label>
                                                                <input
                                                                    matInput
                                                                    formControlName="{{ dimension.name + '_value_element_' + k }}"
                                                                    (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false); updateDimensionValueSelection(documentIndex, dimension.index, k)"
                                                                    class="magnitude_estimation">
                                                                @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'required') &&
                                                                shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                                assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                    <mat-error><span i18n>This field is required</span></mat-error>
                                                                }
                                                                @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'isNumber') &&
                                                                shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                                assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                    <mat-error><span i18n>Value has to be a number (whole or decimal)</span></mat-error>
                                                                }
                                                                @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'numberFormat') &&
                                                                shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                                assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                    <mat-error><span i18n>Numbers must use dot as decimal separator</span></mat-error>
                                                                }
                                                                @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'numberGreaterThan') &&
                                                                shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                                assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                    <mat-error><span i18n>Value has to be greater than</span> {{ dimension.scale.min }}</mat-error>
                                                                }
                                                            </mat-form-field>
                                                        </div>
                                                    }
                                                }
                                            }

                                            @if (dimension.style.orientation == 'horizontal') {
                                                <p i18n>TO BE IMPLEMENTED</p>
                                            }
                                        </div>
                                    </div>
                                }

                                <!-- Pairwise justification (per element) -->
                                @if (dimension.justification) {
                                    <div class="dimension-content-split pairwise-columns">
                                        <div class="pairwise-column-title"><strong>Element A</strong></div>
                                        <div class="pairwise-column-title"><strong>Element B</strong></div>

                                        <!-- Safe accessor: subdocs(documentIndex) returns [] when 'subdocuments' is missing -->
                                        @for (subdoc of getSubdocumentsHelper(documentIndex); track subdoc; let k = $index) {
                                            <div class="dimension-box pairwise-col-surface">
                                                <app-justification-field
                                                    [form]="assessmentForm"
                                                    [controlName]="dimension.name + '_justification_element_' + k"
                                                    [label]="dimension.justification.text"
                                                    [rows]="5"
                                                    [minWords]="dimension.justification.min_words"
                                                    [showCounter]="true"
                                                    [surface]="false"
                                                    [submitted]="submitted"
                                                    [documentIndex]="documentIndex"
                                                    [dimensionIndex]="dimension.index"
                                                    [postAssessmentIndex]="postAssessmentIndex">
                                                </app-justification-field>
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    }

                    <!-- MATRIX-style pairwise placeholder -->
                    @if (dimension.style.type == 'matrix') {
                        <div class="dimension-matrix"><p i18n>TO BE IMPLEMENTED</p></div>
                    }
                }
            </div>
        }
    </form>
</ng-template>

<!-- INITIAL render -->
@if (!postAssessment) {
    @for (pos of ['top', 'middle', 'bottom']; track pos) {
        @for (kind of ['list', 'matrix']; track kind) {
            @let dims = filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos));
            @if (assessmentForm && dims.length > 0) {
                <ng-template
                    [ngTemplateOutlet]="dimensionTemplate"
                    [ngTemplateOutletContext]="{ dimensions: dims, position: pos, assessmentForm: assessmentForm, controlSuffix: '' }">
                </ng-template>
            }
        }
    }
}

<!-- POST-ASSESSMENT render -->
@if (postAssessment && followingAssessmentAllowed) {
    @for (pos of ['top', 'middle', 'bottom']; track pos) {
        @for (kind of ['list', 'matrix']; track kind) {
            @let dims = filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos));
            @if (assessmentFormAdditional && dims.length > 0) {
                <ng-template
                    [ngTemplateOutlet]="dimensionTemplate"
                    [ngTemplateOutletContext]="{ dimensions: dims, position: pos, assessmentForm: assessmentFormAdditional, controlSuffix: '_post_' + postAssessmentIndex }">
                </ng-template>
            }
        }
    }
}
