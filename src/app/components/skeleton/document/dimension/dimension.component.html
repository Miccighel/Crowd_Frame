<!-- ────────────────────────────────────────────────────────────
     Re-usable template that prints a list of dimensions
     (works for both initial and post-assessment forms)
     ──────────────────────────────────────────────────────────── -->
<ng-template
    #dimensionTemplate
    let-dimensions="dimensions"
    let-position="position"
    let-assessmentForm="assessmentForm"
    let-controlSuffix="controlSuffix">

    <form [formGroup]="assessmentForm">
        @for (dimension of dimensions; track dimension) {
            <div class="dimension">
                <!-- ───────────────────────────── NON-PAIRWISE (POINTWISE) ───────────────────────────── -->
                @if (!dimension.pairwise) {

                    <!-- ───────────── LIST STYLE ───────────── -->
                    @if (dimension.style.type == 'list') {
                        <div class="dimension dimension--pointwise">

                            <!-- Search-engine widget (optional) -->
                            <app-search-engine
                                [documentIndex]="documentIndex"
                                [dimensionIndex]="dimension.index"
                                [worker]="worker"
                                [searchEngineForms]="searchEngineForms"
                                [resultsRetrievedForms]="resultsRetrievedForms"
                                (formEmitter)="storeSearchEngineUrl($event, dimension.index)">
                            </app-search-engine>

                            @if (verifyUrlSelection(position) && checkIfDimensionIsEnabledForPostAssessment(dimension.name)) {

                                <!-- Optional instructions (POINTWISE = left aligned by modifier) -->
                                @if (dimension.scale?.instructions; as ins) {
                                    <div class="evaluation-instructions">
                                        @if (!postAssessment) {
                                            <h2>
                                                @if (ins.label) {
                                                    <span>{{ ins.label }} – </span>
                                                }{{ ins.caption }}
                                            </h2>
                                        }
                                        @if (postAssessment && ins.labelRepetition && ins.captionRepetition) {
                                            <h2>
                                                @if (ins.labelRepetition) {
                                                    <span>{{ ins.labelRepetition }} – </span>
                                                }{{ ins.captionRepetition }}
                                            </h2>
                                        }
                                        @if (ins.text) {
                                            <div class="evaluation-instructions-body" [innerHTML]="ins.text"></div>
                                        }
                                    </div>
                                }

                                <!-- Pretty name -->
                                @if (dimension.name_pretty) {
                                    <div class="dimension-name">
                                        <h2>{{ utilsService.capitalize(dimension.name_pretty) }}</h2>
                                    </div>
                                }

                                <!-- Description + Example -->
                                @if (dimension.description || dimension.example) {
                                    <div class="dimension-container dimension-description">
                                        <div class="dimension-content">
                                            @if (dimension.description) {
                                                <p>{{ dimension.description }}</p>
                                            }
                                            @if (dimension.example) {
                                                <i class="dimension-example">{{ dimension.example }}</i>
                                            }
                                        </div>
                                    </div>
                                }

                                <!-- ───────────── SCALE CONTROLS ───────────── -->
                                @if (dimension.scale) {
                                    <div class="dimension-container dimension-scale">
                                        <div class="dimension-content">

                                            <!-- ───── Vertical layout ───── -->
                                            @if (dimension.style.orientation == 'vertical') {

                                                <!-- ─── Categorical ─── -->
                                                @if (dimension.scale.type == 'categorical') {

                                                    <!-- video special-case (secondary categorical disabled based on primary) -->
                                                    @if (isVideoTypeLabelCategorical(dimension)) {
                                                        <mat-radio-group
                                                            class="radio-button-group"
                                                            formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                                            @if (!dimension.scale.multipleSelection) {
                                                                @for (mapping of dimension.scale.mapping; track mapping) {
                                                                    @if (mapping.separator) {
                                                                        <mat-divider inset></mat-divider>
                                                                    }
                                                                    <mat-radio-button
                                                                        class="radio-button"
                                                                        value="{{ mapping.value }}"
                                                                        (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)">
                                                                        <span class="mapping-label">{{ mapping.label }}</span>
                                                                        @if (mapping.description) {
                                                                            <span>{{ ' (' + mapping.description + ')' }}</span>
                                                                        }
                                                                    </mat-radio-button>
                                                                }
                                                            }
                                                            @if (dimension.scale.multipleSelection) {
                                                                <div class="checkbox">
                                                                    <div formGroupName="{{ dimension.name + '_list' + controlSuffix }}">
                                                                        @for (mapping of dimension.scale.mapping; track mapping; let k = $index) {
                                                                            <div>
                                                                                <mat-checkbox
                                                                                    formControlName="{{ k }}"
                                                                                    (change)="handleCheckbox($event, dimension, k)">
                                                                                    {{ mapping.label }}
                                                                                </mat-checkbox>
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                    <mat-form-field>
                                                                        <input matInput formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                                                    </mat-form-field>
                                                                </div>
                                                            }
                                                        </mat-radio-group>

                                                        <!-- categorical required (video special-case) -->
                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required') &&
                                                        shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix) &&
                                                        assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>This field is required</span></mat-error>
                                                        }

                                                    } @else {
                                                        <mat-radio-group
                                                            class="radio-button-group"
                                                            formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                                            @if (!dimension.scale.multipleSelection) {
                                                                @for (mapping of dimension.scale.mapping; track mapping) {
                                                                    @if (mapping.separator) {
                                                                        <mat-divider inset></mat-divider>
                                                                    }
                                                                    <mat-radio-button
                                                                        class="radio-button"
                                                                        value="{{ mapping.value }}"
                                                                        (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false); detectCategoricalDimensionOnChange($event)">
                                                                        <span class="mapping-label">{{ mapping.label }}</span>
                                                                        @if (mapping.description) {
                                                                            <span>{{ ' (' + mapping.description + ')' }}</span>
                                                                        }
                                                                    </mat-radio-button>
                                                                }
                                                            }
                                                            @if (dimension.scale.multipleSelection) {
                                                                <div class="checkbox">
                                                                    <div formGroupName="{{ dimension.name + '_list' + controlSuffix }}">
                                                                        @for (mapping of dimension.scale.mapping; track mapping; let k = $index) {
                                                                            <div>
                                                                                <mat-checkbox
                                                                                    formControlName="{{ k }}"
                                                                                    (change)="handleCheckbox($event, dimension, k)">
                                                                                    {{ mapping.label }}
                                                                                </mat-checkbox>
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                    <mat-form-field>
                                                                        <input matInput formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                                                    </mat-form-field>
                                                                </div>
                                                            }
                                                        </mat-radio-group>

                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required') &&
                                                        shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix) &&
                                                        assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>This field is required</span></mat-error>
                                                        }
                                                    }
                                                }

                                                <!-- ─── Interval ─── -->
                                                @if (dimension.scale.type == 'interval') {

                                                    <!-- video timestamp slider -->
                                                    @if (isVideoTimestampInterval()) {
                                                        <div class="scale-interval">
                                                            <mat-slider
                                                                [min]="task.dimensionIntervalMinValues[documentIndex]"
                                                                [max]="task.dimensionIntervalMaxValues[documentIndex]"
                                                                [step]="dimension.scale.step">
                                                                <input
                                                                    matSliderThumb
                                                                    formControlName="{{ dimension.name + '_value' + controlSuffix }}"
                                                                    (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)">
                                                            </mat-slider>

                                                            @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value == null || assessmentForm.controls[dimension.name + '_value' + controlSuffix].value === '') {
                                                                <span>Value: 00:00.00</span>
                                                            }
                                                            @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value != null && assessmentForm.controls[dimension.name + '_value' + controlSuffix].value !== '') {
                                                                <span>Value: {{ videoTimestampVisualization(assessmentForm.controls[dimension.name + '_value' + controlSuffix].value) }}</span>
                                                            }

                                                            @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required') &&
                                                            shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix) &&
                                                            assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                                <mat-error><br><span>This field is required</span></mat-error>
                                                            }
                                                        </div>
                                                    } @else {
                                                        <div class="scale-interval">
                                                            <mat-slider
                                                                [min]="dimension.scale.min"
                                                                [max]="dimension.scale.max"
                                                                [step]="dimension.scale.step"
                                                                discrete="true">
                                                                <input
                                                                    matSliderThumb
                                                                    formControlName="{{ dimension.name + '_value' + controlSuffix }}"
                                                                    (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)">
                                                            </mat-slider>

                                                            @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value == null || assessmentForm.controls[dimension.name + '_value' + controlSuffix].value === '') {
                                                                <span>Value: #</span>
                                                            }
                                                            @if (assessmentForm.controls[dimension.name + '_value' + controlSuffix].value != null && assessmentForm.controls[dimension.name + '_value' + controlSuffix].value !== '') {
                                                                <span>Value: {{ assessmentForm.controls[dimension.name + '_value' + controlSuffix].value }}</span>
                                                            }

                                                            @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required') &&
                                                            shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix) &&
                                                            assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                                <mat-error><span>This field is required</span></mat-error>
                                                            }
                                                        </div>
                                                    }
                                                }

                                                <!-- ─── Magnitude estimation ─── -->
                                                @if (dimension.scale.type == 'magnitude_estimation') {
                                                    <mat-form-field appearance="fill">
                                                        <mat-label>Value</mat-label>
                                                        <input
                                                            matInput
                                                            formControlName="{{ dimension.name + '_value' + controlSuffix }}"
                                                            (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)"
                                                            class="magnitude_estimation">
                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required') &&
                                                        shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix) &&
                                                        assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>This field is required</span></mat-error>
                                                        }
                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'isNumber') &&
                                                        shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix) &&
                                                        assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>Value has to be a number (whole or decimal)</span></mat-error>
                                                        }
                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'numberFormat') &&
                                                        shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix) &&
                                                        assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>Numbers must use dot as decimal separator (e.g. 1,234.56)</span></mat-error>
                                                        }
                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'numberGreaterThan') &&
                                                        shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix) &&
                                                        assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                            <mat-error><span>Value has to be greater than {{ dimension.scale.min }}</span></mat-error>
                                                        }
                                                    </mat-form-field>
                                                }
                                            }

                                            <!-- ───── Horizontal layout (categorical implemented) ───── -->
                                            @if (dimension.style.orientation == 'horizontal') {
                                                @if (dimension.scale.type == 'categorical') {
                                                    <mat-radio-group formControlName="{{ dimension.name + '_value' + controlSuffix }}">
                                                        @for (mapping of dimension.scale.mapping; track mapping) {
                                                            <mat-radio-button
                                                                class="radio-button"
                                                                value="{{ mapping.value }}"
                                                                (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false)">
                                                                <span class="mapping-label">{{ mapping.label }}</span>
                                                                @if (mapping.description) {
                                                                    <span>{{ ' (' + mapping.description + ')' }}</span>
                                                                }
                                                            </mat-radio-button>
                                                        }
                                                    </mat-radio-group>
                                                    @if (utilsService.hasError(assessmentForm, dimension.name + '_value' + controlSuffix, 'required') &&
                                                    shouldShowValidation(assessmentForm, dimension.name + '_value' + controlSuffix) &&
                                                    assessmentForm.controls[dimension.name + '_value' + controlSuffix].enabled) {
                                                        <mat-error><span>This field is required</span></mat-error>
                                                    }
                                                }

                                                @if (dimension.scale.type == 'interval' || dimension.scale.type == 'magnitude_estimation') {
                                                    <p i18n>TO BE IMPLEMENTED</p>
                                                }
                                            }
                                        </div>
                                    </div>
                                }

                                <!-- ───────────── Justification ───────────── -->
                                @if (dimension.justification) {
                                    <div class="dimension-container dimension-justification">
                                        <div class="dimension-content justification">
                                            <div class="dimension-text-field">
                                                <mat-form-field appearance="fill" class="width-100">
                                                    <mat-label>{{ dimension.justification.text }}</mat-label>
                                                    <textarea
                                                        matInput
                                                        rows="3"
                                                        formControlName="{{ dimension.name + '_justification' + controlSuffix }}"
                                                        (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, true)"></textarea>
                                                    @if (utilsService.hasError(assessmentForm, dimension.name + '_justification' + controlSuffix, 'required') &&
                                                    shouldShowValidation(assessmentForm, dimension.name + '_justification' + controlSuffix) &&
                                                    assessmentForm.controls[dimension.name + '_justification' + controlSuffix].enabled) {
                                                        <mat-error><span>This field is required</span></mat-error>
                                                    }
                                                    @if (utilsService.hasError(assessmentForm, dimension.name + '_justification' + controlSuffix, 'longer') &&
                                                    shouldShowValidation(assessmentForm, dimension.name + '_justification' + controlSuffix) &&
                                                    assessmentForm.controls[dimension.name + '_justification' + controlSuffix].enabled) {
                                                        <mat-error><span>This justification must have at least {{ dimension.justification.min_words }} words.</span></mat-error>
                                                    }
                                                    @if (utilsService.hasError(assessmentForm, dimension.name + '_justification' + controlSuffix, 'invalid') &&
                                                    shouldShowValidation(assessmentForm, dimension.name + '_justification' + controlSuffix) &&
                                                    assessmentForm.controls[dimension.name + '_justification' + controlSuffix].enabled) {
                                                        <mat-error><span>You cannot use the selected search-engine URL as part of the justification.</span></mat-error>
                                                    }
                                                </mat-form-field>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    }

                    <!-- ───────────── MATRIX STYLE (skeleton placeholder) ───────────── -->
                    @if (dimension.style.type == 'matrix') {
                        <div><p i18n>TO BE IMPLEMENTED</p></div>
                    }
                }

                <!-- ───────────────────────────── PAIRWISE ───────────────────────────── -->
                @if (dimension.pairwise) {

                    <!-- LIST-style pairwise -->
                    @if (dimension.style.type == 'list') {
                        <div class="dimension">

                            @if (unlockNextDimension(documentIndex, dimension.index)) {

                                <div class="dimension-name-center">
                                    @if (!dimension.name_pretty) {
                                        <h2>{{ utilsService.capitalize(dimension.name) }}</h2>
                                    }
                                    @if (dimension.name_pretty) {
                                        <h2>{{ utilsService.capitalize(dimension.name_pretty) }}</h2>
                                    }
                                </div>

                                @if (dimension.description || dimension.example) {
                                    <div class="dimension-name-center">
                                        <div class="dimension-split-inside">
                                            @if (dimension.description) {
                                                <p>{{ dimension.description }}</p>
                                            }
                                            @if (dimension.example) {
                                                <i>{{ dimension.example }}</i>
                                            }
                                        </div>
                                    </div>
                                }

                                @if (dimension.scale?.instructions; as ins) {
                                    <div class="evaluation-instructions">
                                        <h2>
                                            @if (ins.label) {
                                                <span>{{ ins.label }} – </span>
                                            }{{ ins.caption }}
                                        </h2>
                                        @if (ins.text) {
                                            <div class="evaluation-instructions-body" [innerHTML]="ins.text"></div>
                                        }
                                    </div>
                                }

                                <app-search-engine
                                    [documentIndex]="documentIndex"
                                    [dimensionIndex]="dimension.index"
                                    [worker]="worker"
                                    [searchEngineForms]="searchEngineForms"
                                    [resultsRetrievedForms]="resultsRetrievedForms"
                                    (formEmitter)="storeSearchEngineUrl($event, dimension.index)">
                                </app-search-engine>

                                @if (dimension.scale) {
                                    <div class="dimension-container dimension-scale">
                                        <div class="dimension-content-split pairwise-columns">

                                            <div class="pairwise-column-title"><strong>Element A</strong></div>
                                            <div class="pairwise-column-title"><strong>Element B</strong></div>

                                            @if (dimension.style.orientation == 'vertical') {

                                                @if (dimension.scale.type == 'categorical') {
                                                    @for (subdoc of task.documents[documentIndex].subdocuments; track subdoc; let k = $index) {
                                                        <div class="dimension-split-inside dimension-box pairwise-col-surface">
                                                            <mat-radio-group
                                                                class="radio-button-group"
                                                                formControlName="{{ dimension.name + '_value_element_' + k }}">
                                                                @for (mapping of dimension.scale.mapping; track mapping) {
                                                                    <mat-radio-button
                                                                        class="radio-button"
                                                                        value="{{ mapping.value }}"
                                                                        (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false); updateDimensionValueSelection(documentIndex, dimension.index, k)">
                                                                        <span class="mapping-label">{{ mapping.label }}</span>
                                                                        @if (mapping.description) {
                                                                            <span>{{ ' (' + mapping.description + ')' }}</span>
                                                                        }
                                                                    </mat-radio-button>
                                                                }
                                                            </mat-radio-group>
                                                            @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'required') &&
                                                            shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                            assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                <mat-error><span i18n>This field is required</span></mat-error>
                                                            }
                                                        </div>
                                                    }
                                                }

                                                @if (dimension.scale.type == 'interval') {
                                                    @for (subdoc of task.documents[documentIndex].subdocuments; track subdoc; let k = $index) {
                                                        <div class="dimension-split-inside dimension-box pairwise-col-surface">
                                                            <label class="pairwise-inline-label">
                                                                <span i18n>Selected value:</span>
                                                                {{ assessmentForm.controls[dimension.name + '_value_element_' + k].value }}
                                                            </label>
                                                            <mat-slider
                                                                [min]="dimension.scale.min"
                                                                [max]="dimension.scale.max"
                                                                [step]="dimension.scale.step"
                                                                discrete="true">
                                                                <input
                                                                    matSliderThumb
                                                                    formControlName="{{ dimension.name + '_value_element_' + k }}"
                                                                    (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false); updateDimensionValueSelection(documentIndex, dimension.index, k)">
                                                            </mat-slider>
                                                            @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'required') &&
                                                            shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                            assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                <mat-error><span i18n>This field is required</span></mat-error>
                                                            }
                                                        </div>
                                                    }
                                                }

                                                @if (dimension.scale.type == 'magnitude_estimation') {
                                                    @for (subdoc of task.documents[documentIndex].subdocuments; track subdoc; let k = $index) {
                                                        <div class="dimension-split-inside dimension-box pairwise-col-surface">
                                                            <mat-form-field appearance="fill" class="pairwise-magnitude-field">
                                                                <mat-label><span i18n>Value</span></mat-label>
                                                                <input
                                                                    matInput
                                                                    formControlName="{{ dimension.name + '_value_element_' + k }}"
                                                                    (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, false); updateDimensionValueSelection(documentIndex, dimension.index, k)"
                                                                    class="magnitude_estimation">
                                                                @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'required') &&
                                                                shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                                assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                    <mat-error><span i18n>This field is required</span></mat-error>
                                                                }
                                                                @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'isNumber') &&
                                                                shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                                assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                    <mat-error><span i18n>Value has to be a number (whole or decimal)</span></mat-error>
                                                                }
                                                                @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'numberFormat') &&
                                                                shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                                assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                    <mat-error><span i18n>Numbers must use dot as decimal separator</span></mat-error>
                                                                }
                                                                @if (utilsService.hasError(assessmentForm, dimension.name + '_value_element_' + k, 'numberGreaterThan') &&
                                                                shouldShowValidation(assessmentForm, dimension.name + '_value_element_' + k) &&
                                                                assessmentForm.controls[dimension.name + '_value_element_' + k].enabled) {
                                                                    <mat-error><span i18n>Value has to be greater than</span> {{ dimension.scale.min }}</mat-error>
                                                                }
                                                            </mat-form-field>
                                                        </div>
                                                    }
                                                }
                                            }

                                            @if (dimension.style.orientation == 'horizontal') {
                                                <p i18n>TO BE IMPLEMENTED</p>
                                            }
                                        </div>
                                    </div>
                                }

                                @if (dimension.justification) {
                                    <div class="dimension-content-split pairwise-columns">
                                        <div class="pairwise-column-title"><strong>Element A</strong></div>
                                        <div class="pairwise-column-title"><strong>Element B</strong></div>

                                        @for (subdoc of task.documents[documentIndex].subdocuments; track subdoc; let k = $index) {
                                            <div class="dimension-box pairwise-col-surface">
                                                <div class="dimension-text-field">
                                                    <mat-form-field appearance="fill">
                                                        <mat-label>{{ dimension.justification.text }}</mat-label>
                                                        <textarea
                                                            matInput
                                                            rows="5"
                                                            formControlName="{{ dimension.name + '_justification_element_' + k }}"
                                                            (change)="task.storeDimensionValue($event, documentIndex, dimension.index, postAssessmentIndex, true)"></textarea>
                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_justification_element_' + k, 'required') &&
                                                        shouldShowValidation(assessmentForm, dimension.name + '_justification_element_' + k) &&
                                                        assessmentForm.controls[dimension.name + '_justification_element_' + k].enabled) {
                                                            <mat-error><span i18n>This field is required</span></mat-error>
                                                        }
                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_justification_element_' + k, 'longer') &&
                                                        shouldShowValidation(assessmentForm, dimension.name + '_justification_element_' + k) &&
                                                        assessmentForm.controls[dimension.name + '_justification_element_' + k].enabled) {
                                                            <mat-error><span i18n>This justification must have at least {{ dimension.justification.min_words }} words.</span></mat-error>
                                                        }
                                                        @if (utilsService.hasError(assessmentForm, dimension.name + '_justification_element_' + k, 'invalid') &&
                                                        shouldShowValidation(assessmentForm, dimension.name + '_justification_element_' + k) &&
                                                        assessmentForm.controls[dimension.name + '_justification_element_' + k].enabled) {
                                                            <mat-error><span i18n>You cannot use the selected search-engine URL as part of the justification.</span></mat-error>
                                                        }
                                                    </mat-form-field>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    }

                    @if (dimension.style.type == 'matrix') {
                        <div class="dimension-matrix"><p i18n>TO BE IMPLEMENTED</p></div>
                    }
                }
            </div>
        }
    </form>
</ng-template>

<!-- ─────────────────── INITIAL (non-post) RENDERING ─────────────────── -->
@if (!postAssessment) {
    @for (pos of ['top', 'middle', 'bottom']; track pos) {
        @for (kind of ['list', 'matrix']; track kind) {
            @if (assessmentForm && filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)).length > 0) {
                <ng-template
                    [ngTemplateOutlet]="dimensionTemplate"
                    [ngTemplateOutletContext]="{
                        dimensions: filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)),
                        position: pos,
                        assessmentForm: assessmentForm,
                        controlSuffix: ''
                    }">
                </ng-template>
            }
        }
    }
}

<!-- ─────────────────── POST-ASSESSMENT RENDERING ─────────────────── -->
@if (postAssessment && followingAssessmentAllowed) {
    @for (pos of ['top', 'middle', 'bottom']; track pos) {
        @for (kind of ['list', 'matrix']; track kind) {
            @if (assessmentFormAdditional && filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)).length > 0) {
                <ng-template
                    [ngTemplateOutlet]="dimensionTemplate"
                    [ngTemplateOutletContext]="{
                        dimensions: filterDimensionsAccordingToTaskType(task.filterDimensions(kind, pos)),
                        position: pos,
                        assessmentForm: assessmentFormAdditional,
                        controlSuffix: '_post_' + postAssessmentIndex
                    }">
                </ng-template>
            }
        }
    }
}
