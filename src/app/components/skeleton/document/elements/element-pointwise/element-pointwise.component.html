<!-- TEMPLATE: Video rendering block -->
<ng-template #videoAttributeBlock let-documentIndex="documentIndex">
    @for (attribute of task.settings.attributesMain; track attribute) {
        @if (attribute.is_video && task.checkCurrentTaskType(task.documents[documentIndex], attribute.show)) {
            <!-- Pairwise-like element card (no extra inner classes); videos are never accented -->
            <div class="element">
                <!-- YouTube videos -->
                @if (task.documents[documentIndex][attribute.name]?.includes('youtube.com')) {
                    <div class="video-container">
                        <iframe width="560" height="315"
                                [src]="task.documents[documentIndex][attribute.name] | safe"
                                title="YouTube video player"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                referrerpolicy="strict-origin-when-cross-origin"
                                allowfullscreen>
                        </iframe>
                    </div>
                }
                <!-- Direct / local video files -->
                @if (!task.documents[documentIndex][attribute.name]?.includes('youtube.com')) {
                    <app-document-video
                        [src]="task.documents[documentIndex][attribute.name]"
                        [docIndex]="documentIndex"
                        [attrName]="attribute.name"
                        [portrait]="isPortraitVideo[documentIndex + '-' + attribute.name]"
                        (metadataLoaded)="onVideoMetadataLoadedFromChild($event)">
                    </app-document-video>
                }
            </div>
        }
    }
</ng-template>

<!-- CASE: Countdown expired AND behavior is to hide attributes -->
@if (task.countdownsExpired?.[documentIndex] &&
task.settings.countdown_behavior === 'hide_attributes') {
    <mat-card appearance="outlined" class="hidden-statement-card">
        <mat-card-content class="hidden-statement-content">
            <mat-icon class="hidden-statement-icon">visibility_off</mat-icon>
            <span class="hidden-statement-message" i18n>
        The content has been hidden as the time expired.
      </span>
        </mat-card-content>
    </mat-card>
}

<!-- CASE: Show content if NOT hidden -->
@if (!(task.countdownsExpired?.[documentIndex] &&
    task.settings.countdown_behavior === 'hide_attributes')) {

    <!-- CASE: Countdown disabled (seconds == 0) -->
    @if (task.getCountdownSeconds(documentIndex) === 0) {

        <!-- NON-VIDEO ATTRIBUTES (single element card) -->
        @if (task.settings.modality === 'pointwise' &&
        !postAssessment &&
        hasRenderableNonVideoAttributes(documentIndex)) {
            <!-- Do not accent in pointwise -->
            <div class="element">
                @for (attribute of task.settings.attributesMain; track attribute) {
                    @if (!attribute.is_video &&
                    task.checkCurrentTaskType(task.documents[documentIndex], attribute.show)) {
                        <p style="white-space: pre-line">
                            @if (attribute.name_pretty) {
                                <strong>{{ attribute.name_pretty }}: </strong>
                            }
                            @if (!attribute.name_pretty) {
                                <strong>{{ attribute.name.split('_').join(' ') | titlecase }}: </strong>
                            }
                            <!-- image attributes -->
                            @if (attribute.isImage(task.documents[documentIndex][attribute.name])) {
                                <br>
                                <img [src]="task.documents[documentIndex][attribute.name]" alt="attribute.name">
                            }
                            <!-- plain-text attributes -->
                            @if (!attribute.isImage(task.documents[documentIndex][attribute.name])) {
                                <span>{{ task.documents[documentIndex][attribute.name] }}</span>
                            }
                        </p>
                    }
                }
            </div>
        }

        <!-- VIDEO ATTRIBUTES (never accented) -->
        <ng-container *ngTemplateOutlet="videoAttributeBlock; context:{ documentIndex: documentIndex }"></ng-container>
    }

    <!-- CASE: Countdown enabled (seconds > 0) -->
    @if (task.getCountdownSeconds(documentIndex) > 0) {
        @if (task.countdownsStarted?.[documentIndex] === false) {
            <div class="skeleton skeleton-card"></div>
        }
        @if (task.countdownsStarted?.[documentIndex] === true) {
            <!-- NON-VIDEO ATTRIBUTES (single element card) -->
            @if (task.settings.modality === 'pointwise' &&
            !postAssessment &&
            hasRenderableNonVideoAttributes(documentIndex)) {
                <!-- Do not accent in pointwise -->
                <div class="element">
                    @for (attribute of task.settings.attributesMain; track attribute) {
                        @if (!attribute.is_video &&
                        task.checkCurrentTaskType(task.documents[documentIndex], attribute.show)) {
                            <p style="white-space: pre-line">
                                @if (attribute.name_pretty) {
                                    <strong>{{ attribute.name_pretty }}: </strong>
                                }
                                @if (!attribute.name_pretty) {
                                    <strong>{{ attribute.name.split('_').join(' ') | titlecase }}: </strong>
                                }
                                <!-- image attributes -->
                                @if (attribute.isImage(task.documents[documentIndex][attribute.name])) {
                                    <br>
                                    <img [src]="task.documents[documentIndex][attribute.name]" alt="attribute.name">
                                }
                                <!-- plain-text attributes -->
                                @if (!attribute.isImage(task.documents[documentIndex][attribute.name])) {
                                    <span>{{ task.documents[documentIndex][attribute.name] }}</span>
                                }
                            </p>
                        }
                    }
                </div>
            }
            <!-- VIDEO ATTRIBUTES (never accented) -->
            <ng-container *ngTemplateOutlet="videoAttributeBlock; context:{ documentIndex: documentIndex }"></ng-container>
        }
    }
}

<!-- CASE: Post-assessment content (unchanged) -->
@if (postAssessment && initialAssessmentFormInteraction) {
    <button mat-stroked-button
            color="accent"
            class="button-continue"
            (click)="unlockNextRepetition(true)">
        <span i18n>Continue Your Assessment</span>
    </button>

    @if (task.settings.modality === 'pointwise' && followingAssessmentAllowed) {
        <ng-container class="evaluation-instructions">
            <h2>{{ attributeForPostAssessment.text }}</h2>
        </ng-container>
    }

    @if (task.settings.modality === 'pointwise' &&
    followingAssessmentAllowed &&
    attributeForPostAssessment) {
        <!-- Do not accent in pointwise -->
        <div class="element">
            <p style="white-space: pre-line;">
                <span>{{ task.documents[documentIndex][attributeForPostAssessment.name] }}</span>
            </p>
        </div>
    }
}
