<ng-template matStepLabel>{{ questionnaire.index }}</ng-template>

<div class="container" id="questionnaire-{{ questionnaire.index }}">
  @if (ready && questionnaireForm) {
    <form [formGroup]="questionnaireForm">
      <mat-card appearance="outlined">
        <mat-card-title>
          @if (questionnaire.name_pretty) {
            <span>
              {{ questionnaire.name_pretty }}
            </span>
          }
          @if (!questionnaire.name_pretty) {
            <span>
              <span i18n>Questionnaire</span> {{ questionnaire.index + 1 }}
            </span>
          }
        </mat-card-title>
        <ng-template #descriptionTemplate let-description>
          @if (description) {
            <div class="questionnaire-description">
              <p class="question-text">{{ description }}</p>
            </div>
          }
        </ng-template>
        <ng-template #captionTemplate let-caption>
          @if (caption) {
            <div class="questionnaire-caption">
              <p class="question-text">{{ caption }}</p>
            </div>
          }
        </ng-template>
        <!-- Recursive question template -->
        <ng-template #questionTemplate let-question>
          @if (!question.dropped) {
            <div class="indent">
              @if (!question.dropped && handleQuestionDependency(question)) {
                <ng-container class="questionnaire-body"
                  >
                  <p class="question-text">
                    {{ question.indexFull }} - {{ question.text }}
                  </p>
                  <!-- MCQ -->
                  @if (question.type === 'mcq') {
                    <div class="question-box question-mcq">
                      <mat-radio-group class="radio-button-group question"
                        [formControlName]="question.nameFull + '_answer'">
                        @for (answer of question.answers; track answer; let k = $index) {
                          <mat-radio-button
                            class="radio-button"
                            [value]="k">
                            <span>{{ answer }}</span>
                          </mat-radio-button>
                        }
                      </mat-radio-group>
                      @if (questionnaireForm.get(question.nameFull + '_answer')?.touched
                        && questionnaireForm.get(question.nameFull + '_answer')?.invalid) {
                        <app-error-message
                          [formField]="questionnaireForm.get(question.nameFull + '_answer')"
                          class="app-error-message">
                        </app-error-message>
                      }
                    </div>
                  }
                  <!-- NUMBER -->
                  @if (question.type === 'number') {
                    <div class="question-box question-number">
                      <mat-form-field appearance="fill" class="questionnaire-value">
                        @if (!question.repeat) {
                          <input
                            matInput type="number" placeholder="Choose a number"
                            min="0"
                            [formControlName]="question.nameFull + '_answer'">
                        }
                        @if (question.repeat) {
                          <input
                            matInput type="number" placeholder="Choose a number"
                            min="0"
                            [max]="question.times"
                            (change)="handleQuestionRepetition(question)"
                            [formControlName]="question.nameFull + '_answer'">
                        }
                        @if (questionnaireForm.get(question.nameFull + '_answer')?.touched
                          && questionnaireForm.get(question.nameFull + '_answer')?.invalid) {
                          <app-error-message
                            [formField]="questionnaireForm.get(question.nameFull + '_answer')"
                            class="app-error-message">
                          </app-error-message>
                        }
                      </mat-form-field>
                    </div>
                  }
                  <!-- LIST / CHECKBOX -->
                  @if (question.type === 'list') {
                    <div class="question-box" [formGroupName]="question.nameFull + '_list'">
                      @for (answer of question.answers; track answer; let k = $index) {
                        <div>
                          <mat-checkbox
                            [formControlName]="k"
                            (change)="handleCheckbox(question, question.nameFull + '_list')">
                            {{ answer }}
                          </mat-checkbox>
                        </div>
                      }
                    </div>
                    @if (displayCheckedLabels(question)) {
                      <div class="checked-summary">
                        <span class="checked-summary-label"><span i18n>Selected:</span></span>
                        <span class="checked-summary-values">{{ displayCheckedLabels(question) }}</span>
                      </div>
                    }
                    @if (questionnaireForm.get(question.nameFull + '_answer')?.touched
                      && questionnaireForm.get(question.nameFull + '_answer')?.invalid) {
                      <app-error-message
                        [formField]="questionnaireForm.get(question.nameFull + '_answer')"
                        class="app-error-message">
                      </app-error-message>
                    }
                  }
                  <!-- DROPDOWN -->
                  @if (question.type === 'dropdown') {
                    <div class="question-box">
                      <mat-form-field appearance="fill" class="questionnaire-value">
                        <mat-label><span i18n>Value</span></mat-label>
                        <mat-select [formControlName]="question.nameFull + '_answer'">
                          @for (answer of question.answers; track answer) {
                            <mat-option [value]="answer">
                              {{ answer }}
                            </mat-option>
                          }
                        </mat-select>
                        @if (questionnaireForm.get(question.nameFull + '_answer')?.touched
                          && questionnaireForm.get(question.nameFull + '_answer')?.invalid) {
                          <app-error-message
                            [formField]="questionnaireForm.get(question.nameFull + '_answer')"
                            class="app-error-message">
                          </app-error-message>
                        }
                      </mat-form-field>
                    </div>
                  }
                  <!-- TEXT / EMAIL -->
                  @if (question.type === 'text' || question.type === 'email') {
                    <div
                      class="question-box">
                      <mat-form-field appearance="fill" class="questionnaire-value width-100">
                        <mat-label><span i18n>Answer</span></mat-label>
                        <textarea matInput
                          placeholder="Write your answer here"
                          rows="2"
                          [formControlName]="question.nameFull + '_answer'">
                        </textarea>
                        @if (questionnaireForm.get(question.nameFull + '_answer')?.touched
                          && questionnaireForm.get(question.nameFull + '_answer')?.invalid) {
                          <app-error-message
                            [formField]="questionnaireForm.get(question.nameFull + '_answer')"
                            class="app-error-message">
                          </app-error-message>
                        }
                      </mat-form-field>
                    </div>
                  }
                  <!-- FREE TEXT -->
                  @if (question.free_text) {
                    <div
                      class="{{ question.required ? 'question-free-text-tall' : 'question-free-text' }}">
                      <mat-form-field appearance="fill" class="questionnaire-value width-100">
                        <mat-label><span i18n>Other</span></mat-label>
                        <textarea matInput
                          placeholder="Write any additional detail here"
                          rows="2"
                          [formControlName]="question.nameFull + '_free_text'">
                        </textarea>
                        @if (questionnaireForm.get(question.nameFull + '_free_text')?.touched
                          && questionnaireForm.get(question.nameFull + '_free_text')?.invalid) {
                          <app-error-message
                            [formField]="questionnaireForm.get(question.nameFull + '_free_text')"
                            class="app-error-message">
                          </app-error-message>
                        }
                      </mat-form-field>
                    </div>
                  }
                  <!-- DETAILS -->
                  @if (question.detail) {
                    <mat-expansion-panel hideToggle="true"
                                         class="question-detail"
                                         (opened)="question.show_detail = true"
                                         (closed)="question.show_detail = false">
                      <mat-expansion-panel-header class="mat-button">
                        <mat-panel-title>
                          {{ question.show_detail ? 'Hide details' : 'Show details' }}
                        </mat-panel-title>
                        <mat-panel-description>
                          {{ question.detail.text }}
                        </mat-panel-description>
                      </mat-expansion-panel-header>
                      @for (element of question.detail.elements; track element) {
                        <div class="question-detail-element"
                          >
                          {{ element.key }}
                          <ul>
                            @for (item of element.items; track item) {
                              <li>{{ item }}</li>
                            }
                          </ul>
                        </div>
                      }
                    </mat-expansion-panel>
                  }
                </ng-container>
              }
            </div>
          }
          <!-- recursive call -->
          @if (question.questions?.length) {
			  <div class="indent">
				@for (q of question.questions; track q.id) {
				  <ng-template
					[ngTemplateOutlet]="questionTemplate"
					[ngTemplateOutletContext]="{ $implicit: q }">
				  </ng-template>
				}
			  </div>
		  }
        </ng-template>
        <!-- STANDARD questionnaire -->
        @if (questionnaire.type === 'standard') {
          <mat-card-content class="questionnaire-standard">
            <ng-template
              [ngTemplateOutlet]="descriptionTemplate"
              [ngTemplateOutletContext]="{ $implicit: questionnaire.description }">
            </ng-template>
            <ng-template
              [ngTemplateOutlet]="captionTemplate"
              [ngTemplateOutletContext]="{ $implicit: questionnaire.caption }">
            </ng-template>
            @for (q of questionnaire.treeCut.questions; track q) {
              <ng-template
                [ngTemplateOutlet]="questionTemplate"
                [ngTemplateOutletContext]="{ $implicit: q }">
              </ng-template>
            }
          </mat-card-content>
        }
        <!-- CRT questionnaire -->
        @if (questionnaire.type === 'crt') {
          <mat-card-content>
            <ng-template
              [ngTemplateOutlet]="descriptionTemplate"
              [ngTemplateOutletContext]="{ $implicit: questionnaire.description }">
            </ng-template>
            <ng-template
              [ngTemplateOutlet]="captionTemplate"
              [ngTemplateOutletContext]="{ $implicit: questionnaire.caption }">
            </ng-template>
            @for (q of questionnaire.questions; track q) {
              <div class="question-box">
                <p class="question-text">{{ q.text }}</p>
                <mat-form-field appearance="fill">
                  <mat-label><span i18n>Answer</span></mat-label>
                  <input matInput type="number" placeholder="0" min="0" max="100"
                    [formControlName]="q.name + '_answer'">
                  </mat-form-field>
                  @if (questionnaireForm.get(q.nameFull + '_answer')?.touched
                    && questionnaireForm.get(q.nameFull + '_answer')?.invalid) {
                    <app-error-message
                      [formField]="questionnaireForm.get(q.nameFull + '_answer')"
                      class="app-error-message">
                    </app-error-message>
                  }
                </div>
              }
            </mat-card-content>
          }
          <!-- LIKERT questionnaire -->
          @if (questionnaire.type === 'likert') {
            <mat-card-content class="questionnaire-matrix">
              <ng-template
                [ngTemplateOutlet]="descriptionTemplate"
                [ngTemplateOutletContext]="{ $implicit: questionnaire.description }">
              </ng-template>
              <ng-template
                [ngTemplateOutlet]="captionTemplate"
                [ngTemplateOutletContext]="{ $implicit: questionnaire.caption }">
              </ng-template>
              <div class="matrix-header">
                <div></div>
                @for (map of questionnaire.mappings; track map) {
                  <div>
                    <strong [class.matrix-header-text-wide]="map.spacing"
                    class="matrix-header-text">{{ map.label }}</strong>
                  </div>
                }
              </div>
              @for (q of questionnaire.questions; track q; let m = $index) {
                <mat-radio-group aria-labelledby="radio-button-label"
                  [formControlName]="q.name + '_answer'">
                  <div>
                    <p class="question-text">
                      @if (q.showIndex) {
                        <span>{{ m + 1 }} - </span>
                        }{{ q.text }}
                      </p>
                    </div>
                    @for (map of questionnaire.mappings; track map) {
                      <div>
                        <mat-radio-button
                          class="radio-button"
                          [class.radio-button-wide]="map.spacing"
                          [value]="map.value">
                        </mat-radio-button>
                      </div>
                    }
                  </mat-radio-group>
                }
              </mat-card-content>
            }
            <!-- Navigation buttons -->
            <mat-card-actions>
              <p class="form-note">
                @if (questionnaire.index > 0 && questionnaire.allow_back) {
                  <button id="questionnaire-{{ questionnaire.index }}-button-previous"
                    mat-flat-button color="primary" matStepperPrevious
                    [disabled]="sectionService.taskCompleted"
                    (click)="handleQuestionnaireCompletion('Back')">
                    <span i18n>Back</span>
                  </button>
                }
                @if (
                  ((questionnaire.index < task.questionnaireAmountStart - 1) && task.documentsAmount == 0) ||
                  ((questionnaire.index <= task.questionnaireAmountStart - 1) && task.documentsAmount > 0) ||
                  (questionnaire.index >= task.questionnaireAmountStart - 1 &&
                  questionnaire.index < task.questionnaireAmount - 1 &&
                  task.questionnaireAmountEnd > 0)) {
                  <button id="questionnaire-{{ questionnaire.index }}-button-next"
                    mat-flat-button color="primary" matStepperNext
                    [disabled]="!questionnaireForm.valid || sectionService.taskCompleted"
                    (click)="handleQuestionnaireCompletion('Next')">
                    <span i18n>Next</span>
                  </button>
                }
                @if (
                  ((questionnaire.index >= task.questionnaireAmountStart - 1) && task.documentsAmount == 0) ||
                  (questionnaire.index >= task.questionnaireAmount - 1 && task.questionnaireAmountEnd > 0)) {
                  <button id="questionnaire-{{ questionnaire.index }}-button-finish"
                    mat-stroked-button color="accent" matStepperNext
                    [disabled]="!questionnaireForm.valid || sectionService.taskCompleted"
                    (click)="handleQuestionnaireCompletion('Finish')">
                    <span i18n>Finish</span>
                  </button>
                }
              </p>
            </mat-card-actions>
          </mat-card>
        </form>
      }
    </div>
