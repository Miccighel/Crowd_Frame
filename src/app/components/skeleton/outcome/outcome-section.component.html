<div class="outcome-section">

    <!-- TITLE -->
    <mat-card appearance="outlined">
        @switch (statusKey) {
            @case ('IP_INFORMATION_MISSING') {
                <mat-card-title class="red-title main-title"><span i18n>Connection Issue</span></mat-card-title>
            }
            @case ('TASK_SUCCESSFUL') {
                <mat-card-title class="green-title main-title"><span i18n>Submission Successful</span></mat-card-title>
            }
            @case ('TASK_ALREADY_COMPLETED') {
                <mat-card-title class="green-title main-title"><span i18n>Submission Already Completed</span></mat-card-title>
            }
            @case ('TASK_FAILED_WITH_TRIES') {
                <mat-card-title class="red-title main-title"><span i18n>Submission Failed</span></mat-card-title>
            }
            @case ('TASK_FAILED_NO_TRIES') {
                <mat-card-title class="red-title main-title"><span i18n>Submission Failed</span></mat-card-title>
            }
            @case ('TASK_OVERBOOKING') {
                <mat-card-title class="yellow-title main-title"><span i18n>Task Overbooked</span></mat-card-title>
            }
            @case ('TASK_TIME_EXPIRED') {
                <mat-card-title class="red-title main-title"><span i18n>Time Expired</span></mat-card-title>
            }
            @case ('TASK_COMPLETED_BY_OTHERS') {
                <mat-card-title class="yellow-title main-title"><span i18n>Task Completed</span></mat-card-title>
            }
            @case ('WORKER_RETURNING_BLOCK') {
                <mat-card-title class="red-title main-title"><span i18n>Blocked</span></mat-card-title>
            }
            @case ('WORKER_BLACKLIST_CURRENT') {
                <mat-card-title class="red-title main-title"><span i18n>Blocked</span></mat-card-title>
            }
            @case ('WORKER_BLACKLIST_PREVIOUS') {
                <mat-card-title class="red-title main-title"><span i18n>Blocked</span></mat-card-title>
            }
            @default {
                <mat-card-title class="red-title main-title"><span i18n>Unknown Issue</span></mat-card-title>
            }
        }
    </mat-card>

    <!-- DESCRIPTION -->
    <mat-card appearance="outlined">
        <mat-card-title class="sub-title"><span i18n>Description</span></mat-card-title>
        <mat-divider [inset]="true"></mat-divider>
        <mat-card-content class="description">

            @switch (statusKey) {

                @case ('IP_INFORMATION_MISSING') {
                    <p>
                        <span i18n>There appears to be a connectivity error between your device and our server. Please report the issue including the status code below and wait for further instructions.</span>
                    </p>
                }
                @case ('TASK_SUCCESSFUL') {
                    <p>
                        <span i18n>Your submission was received successfully.</span>
                    </p>
                }
                @case ('TASK_ALREADY_COMPLETED') {
                    <p>
                        <span i18n>The task started on </span>
                        <strong>{{ worker.prettyTimeArrival() }}</strong>
                        <span i18n> and was completed on </span>
                        <strong>{{ worker.prettyTimeCompletion() }}</strong>.
                        <span i18n>Only one submission per worker is allowed. Payment will be processed shortly. If not already, you can still finalize your submission on the platform.</span>
                    </p>
                }
                @case ('TASK_FAILED_WITH_TRIES') {
                    <p>
                        <span i18n>Your responses did not pass one or more quality checks. You still have </span>
                        <strong>{{ triesLeft }}</strong>
                        <span i18n> attempt(s) available. Reset the task to try again.</span>
                    </p>
                }
                @case ('TASK_FAILED_NO_TRIES') {
                    <p>
                        <span i18n>Your responses did not meet the required quality. Please return this assignment. Thank you for your time, and feel free to join future tasks.</span>
                    </p>
                }
                @case ('TASK_OVERBOOKING') {
                    <p>
                        <span i18n>All tasks are currently assigned. A worker still has time to finish. Please check back after the nearest expiry:</span>
                        {{ worker.getParameter('time_expiration_nearest') }}.
                    </p>
                }
                @case ('TASK_TIME_EXPIRED') {
                    <p>
                        <span i18n>The allotted time expired on </span>
                        <strong>{{ worker.prettyTimeExpiration() }}</strong>.
                        <span i18n>The assignment has been reassigned. Please return the assignment on the original platform.</span>
                    </p>
                }
                @case ('TASK_COMPLETED_BY_OTHERS') {
                    <p>
                        <span
                            i18n>All tasks were completed by other workers and the platform over-recruited. Please return the task to the original platform. We apologize for the inconvenience.</span>
                    </p>
                }
                @case ('WORKER_RETURNING_BLOCK') {
                    <p>
                        <span i18n>This task can be completed only once and cannot be reopened if the browser tab is closed. Please return the assignment on the original platform.</span>
                    </p>
                }
                @case ('WORKER_BLACKLIST_CURRENT') {
                    <p>
                        <span i18n>You cannot participate again in this task. Please return the assignment on the original platform.</span>
                    </p>
                }

                <!-- Kept from original: prior participation prevents current enrollment -->
                @case ('WORKER_WHITELIST_PREVIOUS') {
                    <p>
                        <span i18n>You have participated previously and we are recruiting only new workers. Please return the assignment on the original platform.</span>
                    </p>
                }
                @default {
                    <p>
                        <span i18n>An unexpected issue occurred. Please report it and include the status code below.</span>
                    </p>
                }
            }
        </mat-card-content>
    </mat-card>

    <!-- COMMENT (shown on success or already completed) -->
    @if (statusKey == 'TASK_SUCCESSFUL' || statusKey == 'TASK_ALREADY_COMPLETED') {
        <mat-card appearance="outlined">
            <mat-card-title class="sub-title"><span i18n>Comment</span></mat-card-title>
            <mat-divider [inset]="true"></mat-divider>
            <mat-card-content class="description">
                <p><span i18n>You may leave a single comment to help us improve the task.</span></p>
            </mat-card-content>

            <div class="comment-box">
                <form [formGroup]="commentForm" class="comment-form">
                    <mat-form-field appearance="fill">
            <textarea
                matInput
                [attr.disabled]="commentSent"
                placeholder="Your comment here"
                formControlName="comment"
                rows="5"
            ></textarea>

                        @if (utilsService.hasError(commentForm, 'comment', 'required')) {
                            <mat-error>
                                <span i18n>Please write at least {{ wordsRequired }} words.</span>
                            </mat-error>
                        }
                    </mat-form-field>
                </form>

                @if (commentForm.get('comment')) {
                    <button
                        class="comment-button"
                        mat-flat-button
                        color="primary"
                        [attr.disabled]="commentSent"
                        (click)="performCommentSaving()"
                    >
                        <span i18n>Send</span>
                    </button>

                    @if (commentSent) {
                        <span class="comment-sent-label"><span i18n>Thank you.</span></span>
                    }
                }
            </div>
        </mat-card>
    }

    <!-- SUBMISSION INSTRUCTIONS (platform = environment) -->
    @if (statusKey == 'TASK_SUCCESSFUL') {
        <mat-card appearance="outlined">
            <mat-card-title class="sub-title"><span i18n>Submission Instructions</span></mat-card-title>
            <mat-divider [inset]="true"></mat-divider>

            @switch (platform) {

                @case ('mturk') {
                    <mat-card-content class="description">
                        <p><span i18n>Copy the output token below and paste it on the platform to complete your work.</span></p>
                        <h1>{{ tokenOutput }}</h1>
                    </mat-card-content>
                }
                @case ('toloka') {
                    <mat-card-content class="description">
                        <p><span i18n>Copy the tokens below and paste them on the platform to complete your work.</span></p>
                        <h1><span i18n>Token Input:</span> {{ tokenInput }}</h1>
                        <h1><span i18n>Token Output:</span> {{ tokenOutput }}</h1>
                    </mat-card-content>
                }
                @case ('prolific') {
                    <mat-card-content class="description">
                        <p><span i18n>Use the button below to be redirected to Prolific and complete your submission.</span></p>
                    </mat-card-content>
                    <div class="completion-div">
                        <button mat-flat-button color="primary" class="button-completion" (click)="completeTask()">
                            <span i18n>Complete</span>
                        </button>
                    </div>
                }
                @default {
                    <mat-card-content class="description">
                        <p><span i18n>This task was not published on a platform. Please copy and keep your tokens.</span></p>
                        <h1><span i18n>Token Input:</span> {{ tokenInput }}</h1>
                        <h1><span i18n>Token Output:</span> {{ tokenOutput }}</h1>
                    </mat-card-content>
                }
            }
        </mat-card>
    }

    <!-- TASK RESET -->
    @if (statusKey == 'TASK_FAILED_WITH_TRIES') {
        <mat-card appearance="outlined">
            <mat-card-title class="sub-title"><span i18n>Task Reset</span></mat-card-title>
            <mat-divider [inset]="true"></mat-divider>
            <mat-card-content class="description">
                <p><span i18n>Click the button to reset your current submission. Your previous inputs will be preserved.</span></p>
            </mat-card-content>
            <div>
                <button mat-flat-button color="primary" (click)="performReset.emit(true)"><span i18n>Reset</span></button>
            </div>
        </mat-card>
    }

    <!-- ADDITIONAL MESSAGES -->
    @if (messages.length > 0) {
        <mat-card appearance="outlined">
            <mat-card-title class="sub-title"><span i18n>Additional Messages</span></mat-card-title>
            <mat-divider [inset]="true"></mat-divider>
            <mat-card-content class="description">
                @for (message of messages; track message) {
                    <p>{{ message }}</p>
                }
            </mat-card-content>
        </mat-card>
    }

    <!-- STATUS CODE -->
    <mat-card appearance="outlined">
        <mat-card-title class="sub-title"><span i18n>Status Code</span></mat-card-title>
        <mat-divider [inset]="true"></mat-divider>
        <mat-card-content class="description">
            <p>
                <span i18n>If you contact support, include this status code:</span>
                <strong> {{ statusCodeDisplay }} </strong>
            </p>
        </mat-card-content>
    </mat-card>

</div>
