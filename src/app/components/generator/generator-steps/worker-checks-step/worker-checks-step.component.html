<form [formGroup]="this.formStep">
    <mat-card appearance="outlined" [class.mat-elevation-z3]="true">
        <mat-card-header>
            <mat-card-title><span i18n>Step #7: Worker Checks</span></mat-card-title>
            <mat-card-subtitle><span i18n>Seventh, define all Worker Checks here</span></mat-card-subtitle>
        </mat-card-header>

        <mat-divider></mat-divider>

        <mat-card-content>
            <!-- Global enable/disable -->
            <mat-slide-toggle color="primary" class="mb-16px" formControlName="block">
                <span i18n>Enable Worker Blacklist</span>
            </mat-slide-toggle>

            <mat-divider [inset]="true"></mat-divider>

            <p><span i18n>Add the IDs to consider</span></p>

            <!-- Blacklist (input chips) -->
            <mat-form-field class="width-100" appearance="fill">
                <mat-label><span i18n>Worker IDs Blacklisted</span></mat-label>
                <mat-chip-grid #blacklistChips formControlName="blacklist" multiple>
                    @for (workerId of this.blacklistedWorkerId; track workerId) {
                        <mat-chip-row [removable]="true" (removed)="removeBlacklistedId(workerId)">
                            {{ workerId }}
                            <mat-icon matChipRemove><span i18n>cancel</span></mat-icon>
                        </mat-chip-row>
                    }
                    <input
                        placeholder="New worker ID ..."
                        [matChipInputFor]="blacklistChips"
                        [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                        [matChipInputAddOnBlur]="true"
                        (matChipInputTokenEnd)="addBlacklistedId($event)">
                </mat-chip-grid>
                <mat-hint align="start">
                    <span i18n>Use SPACE, comma, or Enter. Allowed: letters, numbers, “-”, “_”.</span>
                </mat-hint>
            </mat-form-field>

            <mat-divider [inset]="true"></mat-divider>

            <!-- Whitelist (input chips) -->
            <mat-form-field class="width-100" appearance="fill">
                <mat-label><span i18n>Worker IDs Whitelisted</span></mat-label>
                <mat-chip-grid #whitelistChips formControlName="whitelist" multiple>
                    @for (workerId of this.whitelistedWorkerId; track workerId) {
                        <mat-chip-row [removable]="true" (removed)="removeWhitelistedId(workerId)">
                            {{ workerId }}
                            <mat-icon matChipRemove><span i18n>cancel</span></mat-icon>
                        </mat-chip-row>
                    }
                    <input
                        placeholder="New worker ID ..."
                        [matChipInputFor]="whitelistChips"
                        [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                        [matChipInputAddOnBlur]="true"
                        (matChipInputTokenEnd)="addWhitelistedId($event)">
                </mat-chip-grid>
                <mat-hint align="start">
                    <span i18n>Use SPACE, comma, or Enter. Allowed: letters, numbers, “-”, “_”.</span>
                </mat-hint>
            </mat-form-field>

            <mat-divider [inset]="true"></mat-divider>

            <h3 class="lighter"><span i18n>Batches</span></h3>

            <div formArrayName="batches" class="mt-16px">
                @if (this.batches().controls.length <= 0) {
                    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                }

                @if (this.batches().controls.length > 0) {
                    @for (taskNode of this.batchesTree; track taskNode) {
                        <div>
                            <mat-accordion class="generator-accordion">
                                <mat-expansion-panel>
                                    <mat-expansion-panel-header>
                                        <mat-panel-title>
                                            {{ taskNode['task'] }}
                                        </mat-panel-title>
                                        <mat-panel-description></mat-panel-description>
                                    </mat-expansion-panel-header>

                                    @for (batch of taskNode['batches']; track batch) {
                                        <!-- 'counter' is a valid index set in TS -->
                                        <div [formGroupName]="batch['counter']" class="mb-16px">
                                            <mat-label class="block mb-8px">{{ batch['batch'] }}</mat-label>

                                            <!-- Batch mode: None / Blacklist / Whitelist -->
                                            <mat-chip-listbox
                                                [multiple]="false"
                                                [value]="getBatchMode(batch['counter'])"
                                                (valueChange)="setBatchMode(batch['counter'], $event)">
                                                <mat-chip-option value="none"><span i18n>None</span></mat-chip-option>
                                                <mat-chip-option value="blacklist"><span i18n>Blacklist</span></mat-chip-option>
                                                <mat-chip-option value="whitelist"><span i18n>Whitelist</span></mat-chip-option>
                                            </mat-chip-listbox>
                                        </div>
                                    }
                                </mat-expansion-panel>
                            </mat-accordion>
                        </div>
                    }
                }
            </div>
        </mat-card-content>

        <mat-divider></mat-divider>

        <mat-card-actions>
            <button mat-flat-button color="primary" matStepperPrevious><span i18n>Back</span></button>
            <button mat-flat-button color="primary" matStepperNext><span i18n>Next</span></button>
        </mat-card-actions>
    </mat-card>
</form>
